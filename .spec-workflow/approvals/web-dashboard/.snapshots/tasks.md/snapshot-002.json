{
  "id": "snapshot_1764068471303_a29552goe",
  "approvalId": "approval_1764068296507_fnx1y2wr7",
  "approvalTitle": "Web Dashboard Tasks Document",
  "version": 2,
  "timestamp": "2025-11-25T11:01:11.303Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Implementation Tasks: Web Dashboard\n\n## Task 1: Project Setup and Design System\n\n### Task 1.1: Create Dashboard Module Structure\n- [ ] Create `src/cardlink/dashboard/` directory structure\n- [ ] Create `__init__.py` with public API exports\n- [ ] Create `static/` directory for frontend assets\n- [ ] Create `static/css/`, `static/js/`, `static/js/components/`, `static/js/utils/`\n\n**Files to create:**\n- `src/cardlink/dashboard/__init__.py`\n- `src/cardlink/dashboard/static/index.html`\n\n### Task 1.2: Implement Design Tokens\n- [ ] Create `tokens.css` with CSS custom properties\n- [ ] Define color palette (primary, success, warning, error, neutrals)\n- [ ] Define typography scale (font families, sizes, weights)\n- [ ] Define spacing system (4px base unit)\n- [ ] Define border radius, shadows, transitions\n- [ ] Implement dark theme overrides with `[data-theme=\"dark\"]`\n\n**Files to create:**\n- `src/cardlink/dashboard/static/css/tokens.css`\n\n### Task 1.3: Implement Base Styles\n- [ ] Create `base.css` with CSS reset/normalize\n- [ ] Define base element styles (body, headings, links, code)\n- [ ] Define form element base styles (inputs, buttons, selects)\n- [ ] Set up scrollbar styling for dark/light themes\n\n**Files to create:**\n- `src/cardlink/dashboard/static/css/base.css`\n\n### Task 1.4: Implement Component Styles\n- [ ] Create `components.css` with BEM-named component styles\n- [ ] Style session cards (.session-card, modifiers, elements)\n- [ ] Style log entries (.log-entry, direction variants, status badges)\n- [ ] Style alert banners (.alert-banner, type variants)\n- [ ] Style buttons (.btn, variants: primary, secondary, danger, disabled)\n- [ ] Style modals (.modal, overlay, content)\n- [ ] Style form controls (.input, .select, .checkbox)\n\n**Files to create:**\n- `src/cardlink/dashboard/static/css/components.css`\n\n### Task 1.5: Implement Utility Classes\n- [ ] Create `utilities.css` with utility classes\n- [ ] Text utilities (alignment, colors, sizes)\n- [ ] Spacing utilities (margin, padding)\n- [ ] Display utilities (flex, grid, hidden)\n- [ ] Layout utilities (containers, columns)\n\n**Files to create:**\n- `src/cardlink/dashboard/static/css/utilities.css`\n\n### Task 1.6: Create Main HTML Page\n- [ ] Create `index.html` with semantic structure\n- [ ] Include all CSS files\n- [ ] Include all JS files (defer loading)\n- [ ] Set up main layout containers (header, main, panels)\n- [ ] Add meta tags for viewport, theme-color\n- [ ] Add loading state skeleton\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/index.html`\n\n---\n\n## Task 2: Core JavaScript Infrastructure\n\n### Task 2.1: Implement StateManager\n- [ ] Create `state.js` with StateManager class\n- [ ] Implement state structure (sessions, logs, alerts, metrics, settings, connection)\n- [ ] Implement `getState(path)` method with dot notation support\n- [ ] Implement `setState(path, value)` method with immutable updates\n- [ ] Implement `subscribe(path, callback)` method\n- [ ] Implement `loadFromStorage()` for settings persistence\n- [ ] Implement `persistToStorage()` for settings persistence\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/state.js`\n\n### Task 2.2: Implement WebSocketClient\n- [ ] Create `websocket.js` with WebSocketClient class\n- [ ] Implement `connect()` with connection handling\n- [ ] Implement auto-reconnect with exponential backoff\n- [ ] Implement `disconnect()` for graceful close\n- [ ] Implement `send(message)` for outgoing messages\n- [ ] Implement message routing to StateManager\n- [ ] Update connection status in state on connect/disconnect\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/websocket.js`\n\n### Task 2.3: Implement APIClient\n- [ ] Create `api.js` with APIClient class\n- [ ] Implement `getSessions()` - GET /api/sessions\n- [ ] Implement `getSessionLogs(sessionId, options)` - GET /api/sessions/{id}/logs\n- [ ] Implement `getMetrics()` - GET /api/metrics\n- [ ] Implement `sendCommand(sessionId, command)` - POST /api/sessions/{id}/commands\n- [ ] Implement `exportLogs(options)` - GET /api/export\n- [ ] Handle errors with meaningful messages\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/api.js`\n\n### Task 2.4: Implement DashboardApp\n- [ ] Create `app.js` with DashboardApp class\n- [ ] Initialize StateManager, WebSocketClient, APIClient\n- [ ] Create and mount all UI components\n- [ ] Implement `init()` async method for startup\n- [ ] Load initial data (sessions, metrics)\n- [ ] Set up global keyboard shortcuts\n- [ ] Handle theme initialization from localStorage\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/app.js`\n\n### Task 2.5: Write Core Infrastructure Tests\n- [ ] Test StateManager state updates and subscriptions\n- [ ] Test StateManager localStorage persistence\n- [ ] Test APIClient request/response handling\n- [ ] Test WebSocketClient reconnection logic\n\n**Files to create:**\n- `tests/unit/dashboard/test_state.js` (or Python tests for backend)\n\n---\n\n## Task 3: Utility Functions\n\n### Task 3.1: Implement Hex Utilities\n- [ ] Create `utils/hex.js` with hex formatting functions\n- [ ] Implement `formatHex(bytes, style)` - uppercase/lowercase/grouped\n- [ ] Implement `parseHex(hexString)` - string to bytes\n- [ ] Implement `isValidHex(string)` - validation\n- [ ] Implement `hexToAscii(hexString)` - hex to ASCII preview\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/utils/hex.js`\n\n### Task 3.2: Implement Time Utilities\n- [ ] Create `utils/time.js` with time formatting functions\n- [ ] Implement `formatRelative(timestamp)` - \"2 minutes ago\"\n- [ ] Implement `formatLocal(timestamp)` - local timezone\n- [ ] Implement `formatUTC(timestamp)` - UTC format\n- [ ] Implement `formatDuration(ms)` - \"1.23s\" format\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/utils/time.js`\n\n### Task 3.3: Implement APDU Utilities\n- [ ] Create `utils/apdu.js` with APDU decoding functions\n- [ ] Implement `decodeAPDU(hexString)` - parse CLA, INS, P1, P2, Lc, Data, Le\n- [ ] Implement `getINSName(insCode)` - lookup INS code name\n- [ ] Implement `getStatusWordMeaning(sw)` - interpret status word\n- [ ] Implement `formatDecodedAPDU(decoded)` - human-readable format\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/utils/apdu.js`\n\n### Task 3.4: Implement VirtualScroller\n- [ ] Create `utils/virtual-scroll.js` with VirtualScroller class\n- [ ] Implement constructor with options (itemHeight, bufferSize, renderItem)\n- [ ] Implement `setItems(items)` for data updates\n- [ ] Implement `appendItems(items)` for adding new items\n- [ ] Implement `scrollToEnd()` for auto-scroll\n- [ ] Implement scroll event handling for rendering visible items\n- [ ] Optimize with requestAnimationFrame\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/utils/virtual-scroll.js`\n\n---\n\n## Task 4: UI Components - Header and Navigation\n\n### Task 4.1: Implement HeaderComponent\n- [ ] Create `components/header.js` with HeaderComponent class\n- [ ] Implement `render()` method with header HTML\n- [ ] Display connection status indicator (colored dot)\n- [ ] Display metrics badges (sessions, commands)\n- [ ] Add settings button to open SettingsModal\n- [ ] Subscribe to state changes for real-time updates\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/components/header.js`\n\n### Task 4.2: Implement ToastManager\n- [ ] Create `components/toast.js` with ToastManager class\n- [ ] Implement `show(message, type, duration)` method\n- [ ] Implement `success(message)`, `error(message)`, `info(message)` helpers\n- [ ] Create toast container at bottom-right\n- [ ] Implement auto-dismiss with animation\n- [ ] Stack multiple toasts vertically\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/components/toast.js`\n\n---\n\n## Task 5: UI Components - Session Panel\n\n### Task 5.1: Implement SessionPanel\n- [ ] Create `components/session-panel.js` with SessionPanel class\n- [ ] Implement `render()` method with session list container\n- [ ] Implement `formatSessionCard(session)` for card HTML\n- [ ] Display session state indicator (active=green, closed=gray)\n- [ ] Display PSK identity, cipher suite, connection time, command count\n- [ ] Show NULL cipher warning badge when applicable\n- [ ] Subscribe to sessions state changes\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/components/session-panel.js`\n\n### Task 5.2: Implement Session Selection\n- [ ] Implement `selectSession(sessionId)` method\n- [ ] Update selectedSession in state\n- [ ] Highlight selected session card\n- [ ] Trigger APDU log filtering by selected session\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/components/session-panel.js`\n\n### Task 5.3: Implement Empty State\n- [ ] Display \"Waiting for connections...\" when no sessions\n- [ ] Show helpful illustration or icon\n- [ ] Include guidance text for first-time users\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/components/session-panel.js`\n\n---\n\n## Task 6: UI Components - APDU Log\n\n### Task 6.1: Implement APDULogComponent Core\n- [ ] Create `components/apdu-log.js` with APDULogComponent class\n- [ ] Implement `render()` method with log container\n- [ ] Integrate VirtualScroller for performance\n- [ ] Implement `formatEntry(entry)` for log entry HTML\n- [ ] Color-code by direction (received=blue, sent=green)\n- [ ] Display status word badges with colors\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/components/apdu-log.js`\n\n### Task 6.2: Implement Log Entry Formatting\n- [ ] Display direction icon (arrow up/down)\n- [ ] Display timestamp (formatted per settings)\n- [ ] Display command name (SELECT, GET STATUS, etc.)\n- [ ] Display hex bytes (formatted per settings)\n- [ ] Display response time for responses\n- [ ] Display status word badge (color-coded)\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/components/apdu-log.js`\n\n### Task 6.3: Implement Entry Expansion\n- [ ] Implement click handler for log entries\n- [ ] Implement `expandEntry(entryId)` method\n- [ ] Create expanded detail view HTML\n- [ ] Display full decoded APDU (CLA, INS, P1, P2, Lc, Data, Le)\n- [ ] Display session info, timestamp, duration\n- [ ] Add close button to collapse\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/components/apdu-log.js`\n\n### Task 6.4: Implement Log Filtering\n- [ ] Add filter toolbar to log component\n- [ ] Implement session filter dropdown\n- [ ] Implement command type filter dropdown\n- [ ] Implement status word filter input\n- [ ] Implement `filter(criteria)` method\n- [ ] Update displayed logs based on filters\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/components/apdu-log.js`\n\n### Task 6.5: Implement Auto-Scroll\n- [ ] Implement `addEntry(entry)` method for new entries\n- [ ] Check if user has scrolled up (disable auto-scroll)\n- [ ] Auto-scroll to bottom when new entries arrive (if enabled)\n- [ ] Show \"New entries\" indicator when auto-scroll disabled\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/components/apdu-log.js`\n\n### Task 6.6: Implement Copy to Clipboard\n- [ ] Add click handler on hex bytes\n- [ ] Copy hex to clipboard on click\n- [ ] Show toast confirmation \"Copied to clipboard\"\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/components/apdu-log.js`\n\n---\n\n## Task 7: UI Components - Command Builder\n\n### Task 7.1: Implement CommandBuilder Core\n- [ ] Create `components/command-builder.js` with CommandBuilder class\n- [ ] Implement `render()` method with form structure\n- [ ] Add session selector dropdown\n- [ ] Add template selector dropdown\n- [ ] Add raw hex input field\n- [ ] Add send button with loading state\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/components/command-builder.js`\n\n### Task 7.2: Implement Command Templates\n- [ ] Create `templates.js` with command template definitions\n- [ ] Define SELECT template with AID field\n- [ ] Define GET STATUS templates (ISD, Applications, Load Files)\n- [ ] Define GET DATA template with tag field\n- [ ] Define INITIALIZE UPDATE template\n- [ ] Implement `build(fields)` function for each template\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/templates.js`\n\n### Task 7.3: Implement Dynamic Form Fields\n- [ ] Implement `selectTemplate(templateName)` method\n- [ ] Generate form fields based on template definition\n- [ ] Support field types: hex, select, text\n- [ ] Add inline help/tooltips for fields\n- [ ] Validate inputs in real-time\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/components/command-builder.js`\n\n### Task 7.4: Implement Command Preview\n- [ ] Show real-time hex preview as fields change\n- [ ] Update preview on any field change\n- [ ] Format hex according to settings\n- [ ] Highlight invalid input\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/components/command-builder.js`\n\n### Task 7.5: Implement Command Sending\n- [ ] Implement `sendCommand()` method\n- [ ] Validate command before sending\n- [ ] Show loading state on button\n- [ ] Call APIClient.sendCommand()\n- [ ] Display response inline\n- [ ] Show toast on success/error\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/components/command-builder.js`\n\n### Task 7.6: Implement Disabled State\n- [ ] Disable form when no active session\n- [ ] Show explanation message\n- [ ] Automatically enable when session becomes active\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/components/command-builder.js`\n\n### Task 7.7: Implement Keyboard Shortcut\n- [ ] Add Ctrl+Enter to send command\n- [ ] Add Escape to clear form\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/components/command-builder.js`\n\n---\n\n## Task 8: UI Components - Alerts and Settings\n\n### Task 8.1: Implement AlertBanner\n- [ ] Create `components/alert-banner.js` with AlertBanner class\n- [ ] Implement `render()` method with alert container\n- [ ] Implement `showAlert(alert)` method with animation\n- [ ] Implement `dismissAlert(alertId)` method\n- [ ] Style by alert type (error=red, warning=amber)\n- [ ] Include icon, message, dismiss button\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/components/alert-banner.js`\n\n### Task 8.2: Implement Alert Types\n- [ ] Handle `error` alerts (connection interrupted)\n- [ ] Handle `warning` alerts (NULL cipher, high error rate)\n- [ ] Handle `psk_mismatch` alerts with identity and IP\n- [ ] Auto-dismiss info alerts after 10 seconds\n- [ ] Persist error alerts until dismissed\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/components/alert-banner.js`\n\n### Task 8.3: Implement SettingsModal\n- [ ] Create `components/settings-modal.js` with SettingsModal class\n- [ ] Implement `open()` and `close()` methods\n- [ ] Implement `render()` with settings form\n- [ ] Add theme toggle (light/dark)\n- [ ] Add hex format selector (uppercase/lowercase/grouped)\n- [ ] Add timestamp format selector (relative/local/UTC)\n- [ ] Add auto-scroll toggle\n- [ ] Add max log entries input\n\n**Files to create:**\n- `src/cardlink/dashboard/static/js/components/settings-modal.js`\n\n### Task 8.4: Implement Settings Persistence\n- [ ] Implement `saveSettings()` to localStorage\n- [ ] Load settings on app init\n- [ ] Apply theme immediately on change\n- [ ] Reset defaults button\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/components/settings-modal.js`\n\n### Task 8.5: Implement Modal Accessibility\n- [ ] Trap focus within modal\n- [ ] Close on Escape key\n- [ ] Close on overlay click\n- [ ] Return focus to trigger element on close\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/components/settings-modal.js`\n\n---\n\n## Task 9: Backend - Dashboard Server\n\n### Task 9.1: Implement Dashboard Server\n- [ ] Create `server.py` with dashboard HTTP server\n- [ ] Serve static files from `static/` directory\n- [ ] Configure CORS for development\n- [ ] Add health check endpoint `/health`\n- [ ] Support configurable port\n\n**Files to create:**\n- `src/cardlink/dashboard/server.py`\n\n### Task 9.2: Implement REST API Routes\n- [ ] Create `routes/api.py` with API endpoints\n- [ ] Implement `GET /api/sessions` - list sessions\n- [ ] Implement `GET /api/sessions/{id}` - session details\n- [ ] Implement `GET /api/sessions/{id}/logs` - session logs with pagination\n- [ ] Implement `GET /api/metrics` - server metrics\n- [ ] Implement `POST /api/sessions/{id}/commands` - send command\n\n**Files to create:**\n- `src/cardlink/dashboard/routes/__init__.py`\n- `src/cardlink/dashboard/routes/api.py`\n\n### Task 9.3: Implement Export Routes\n- [ ] Create `routes/export.py` with export endpoints\n- [ ] Implement `GET /api/export?format=json` - JSON export\n- [ ] Implement `GET /api/export?format=csv` - CSV export\n- [ ] Support filtering by session_id, start, end\n- [ ] Set appropriate Content-Disposition header for download\n\n**Files to create:**\n- `src/cardlink/dashboard/routes/export.py`\n\n### Task 9.4: Implement WebSocket Handler\n- [ ] Create `websocket.py` with WebSocket handler\n- [ ] Subscribe to AdminServer EventEmitter\n- [ ] Forward events to connected clients\n- [ ] Handle client connection/disconnection\n- [ ] Handle `send_command` messages from client\n\n**Files to create:**\n- `src/cardlink/dashboard/websocket.py`\n\n### Task 9.5: Integrate with AdminServer\n- [ ] Add `--dashboard` flag to server CLI\n- [ ] Start dashboard server when flag enabled\n- [ ] Share EventEmitter between AdminServer and Dashboard\n- [ ] Share SessionManager for command routing\n\n**Files to modify:**\n- `src/cardlink/cli/server.py`\n- `src/cardlink/server/admin_server.py`\n\n---\n\n## Task 10: Data Presentation and UX\n\n### Task 10.1: Implement Human-Readable Formats\n- [ ] Format timestamps as \"2 minutes ago\" with full date on hover\n- [ ] Format durations as \"1.23s\" not \"1234ms\"\n- [ ] Format byte sizes as \"1.5 KB\" not \"1536 bytes\"\n- [ ] Add title attributes for full values\n\n**Files to modify:**\n- `src/cardlink/dashboard/static/js/utils/time.js`\n\n### Task 10.2: Implement Inline Help\n- [ ] Add tooltips for technical terms (PSK, APDU, SW)\n- [ ] Add field descriptions in command builder\n- [ ] Add help icons with popover explanations\n\n**Files to modify:**\n- Multiple component files\n\n### Task 10.3: Implement Loading States\n- [ ] Add skeleton loaders for initial page load\n- [ ] Add spinner for command sending\n- [ ] Add loading indicator for log loading\n\n**Files to modify:**\n- Multiple component files\n\n### Task 10.4: Implement Empty States\n- [ ] Design empty state for no sessions\n- [ ] Design empty state for no logs\n- [ ] Include helpful guidance text\n\n**Files to modify:**\n- Multiple component files\n\n### Task 10.5: Implement Error States\n- [ ] Show meaningful error messages\n- [ ] Include recovery suggestions\n- [ ] Log errors to console for debugging\n\n**Files to modify:**\n- Multiple component files\n\n---\n\n## Task 11: Testing\n\n### Task 11.1: Write Backend Unit Tests\n- [ ] Test API route handlers\n- [ ] Test export formatting (JSON, CSV)\n- [ ] Test WebSocket message handling\n\n**Files to create:**\n- `tests/unit/dashboard/test_api.py`\n- `tests/unit/dashboard/test_export.py`\n- `tests/unit/dashboard/test_websocket.py`\n\n### Task 11.2: Write Frontend Unit Tests\n- [ ] Test hex utilities\n- [ ] Test time utilities\n- [ ] Test APDU decoder\n- [ ] Test VirtualScroller\n\n**Files to create:**\n- `tests/unit/dashboard/test_utils.js` (or use Jest/Vitest)\n\n### Task 11.3: Write Integration Tests\n- [ ] Test dashboard loads and connects\n- [ ] Test session appears on WebSocket event\n- [ ] Test command sending flow\n- [ ] Test export download\n\n**Files to create:**\n- `tests/integration/test_dashboard.py`\n\n### Task 11.4: Write E2E Tests\n- [ ] Test full page load and initialization\n- [ ] Test real-time updates appear\n- [ ] Test command builder workflow\n- [ ] Test settings persistence\n\n**Files to create:**\n- `tests/e2e/test_dashboard_e2e.py`\n\n---\n\n## Task 12: Documentation and Polish\n\n### Task 12.1: Add Keyboard Shortcuts Documentation\n- [ ] Document all keyboard shortcuts\n- [ ] Add shortcuts help in settings or help modal\n\n### Task 12.2: Add Onboarding\n- [ ] Implement first-run welcome message\n- [ ] Show quick-start steps for new users\n- [ ] Add feature discovery hints\n\n### Task 12.3: Performance Optimization\n- [ ] Profile and optimize render performance\n- [ ] Ensure virtual scrolling handles 10,000+ entries\n- [ ] Test memory usage over long sessions\n\n### Task 12.4: Cross-Browser Testing\n- [ ] Test on Chrome, Firefox, Safari, Edge\n- [ ] Fix any browser-specific issues\n- [ ] Verify responsive design at 1280px\n\n---\n\n## Summary\n\n| Task Group | Tasks | Description |\n|------------|-------|-------------|\n| Task 1 | 1.1 - 1.6 | Project setup and design system |\n| Task 2 | 2.1 - 2.5 | Core JavaScript infrastructure |\n| Task 3 | 3.1 - 3.4 | Utility functions |\n| Task 4 | 4.1 - 4.2 | Header and navigation |\n| Task 5 | 5.1 - 5.3 | Session panel |\n| Task 6 | 6.1 - 6.6 | APDU log component |\n| Task 7 | 7.1 - 7.7 | Command builder |\n| Task 8 | 8.1 - 8.5 | Alerts and settings |\n| Task 9 | 9.1 - 9.5 | Backend server |\n| Task 10 | 10.1 - 10.5 | Data presentation and UX |\n| Task 11 | 11.1 - 11.4 | Testing |\n| Task 12 | 12.1 - 12.4 | Documentation and polish |\n\n**Total: 12 task groups, 52 subtasks**\n",
  "fileStats": {
    "size": 20964,
    "lines": 611,
    "lastModified": "2025-11-25T10:58:11.271Z"
  },
  "comments": []
}