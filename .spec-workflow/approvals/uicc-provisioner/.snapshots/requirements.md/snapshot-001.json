{
  "id": "snapshot_1764070359485_12i0pa2z7",
  "approvalId": "approval_1764070359469_uhd1bk9yg",
  "approvalTitle": "UICC Provisioner Requirements Document",
  "version": 1,
  "timestamp": "2025-11-25T11:32:39.485Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document: UICC Provisioner\n\n## Introduction\n\nThe UICC Provisioner is the CardLink component responsible for pre-configuring UICC cards for SCP81 OTA testing. It provides PC/SC-based smart card access to configure PSK keys, admin server URLs, trigger mechanisms, and other parameters required before cards can participate in OTA test sessions.\n\nThis component enables testers to prepare test cards with proper SCP81 credentials and configuration without relying on production OTA infrastructure or manual card personalization processes.\n\n## Alignment with Product Vision\n\nThis feature directly supports CardLink's core mission of providing accessible SCP81 compliance testing:\n\n- **Real hardware testing**: Configures actual UICC cards for real-world testing\n- **Local-first design**: PC/SC reader access without network infrastructure\n- **Protocol transparency**: Full APDU logging during provisioning operations\n- **Self-service setup**: Testers can prepare their own test cards\n- **Standards compliance**: Follows GlobalPlatform card personalization procedures\n\n## Requirements\n\n### Requirement 1: PC/SC Reader Discovery and Connection\n\n**User Story:** As a tester, I want the provisioner to discover connected smart card readers, so that I can select a reader and access my UICC card.\n\n#### Acceptance Criteria\n\n1. WHEN the provisioner starts THEN it SHALL scan for available PC/SC readers\n2. WHEN readers are found THEN the provisioner SHALL list all with names and connection status\n3. WHEN a card is inserted THEN the provisioner SHALL detect it within 2 seconds\n4. WHEN a card is removed THEN the provisioner SHALL detect removal within 2 seconds\n5. WHEN no reader is found THEN the provisioner SHALL display troubleshooting message\n6. WHEN multiple readers are present THEN the provisioner SHALL allow reader selection\n7. WHEN pcscd is not running THEN the provisioner SHALL display service activation instructions\n\n### Requirement 2: Card Discovery and ATR Analysis\n\n**User Story:** As a tester, I want to identify inserted UICC cards and understand their capabilities, so that I can verify I'm working with the correct card type.\n\n#### Acceptance Criteria\n\n1. WHEN a card is detected THEN the provisioner SHALL read and display the ATR (Answer To Reset)\n2. WHEN analyzing ATR THEN the provisioner SHALL identify:\n   - Card type (UICC, SIM, eUICC)\n   - Supported protocols (T=0, T=1)\n   - Historical bytes interpretation\n3. WHEN querying EF_ICCID THEN the provisioner SHALL display the ICCID\n4. WHEN querying EF_IMSI THEN the provisioner SHALL display the IMSI (if accessible)\n5. WHEN analyzing card THEN the provisioner SHALL detect GlobalPlatform support\n6. WHEN card doesn't respond THEN the provisioner SHALL report communication error\n\n### Requirement 3: Security Domain Management\n\n**User Story:** As a UICC developer, I want to manage Security Domains on the card, so that I can configure administrative access for OTA testing.\n\n#### Acceptance Criteria\n\n1. WHEN selecting ISD THEN the provisioner SHALL use SELECT by AID (A000000151000000)\n2. WHEN authenticating THEN the provisioner SHALL support SCP02 and SCP03 protocols\n3. WHEN listing SDs THEN the provisioner SHALL use GET STATUS command\n4. WHEN querying SD THEN the provisioner SHALL return:\n   - AID\n   - Life cycle state\n   - Privileges\n   - Associated Security Domain\n5. WHEN creating SD THEN the provisioner SHALL support INSTALL [for install] command\n6. WHEN deleting SD THEN the provisioner SHALL support DELETE command with proper cascade handling\n7. WHEN updating SD THEN the provisioner SHALL support PUT KEY and SET STATUS commands\n\n### Requirement 4: PSK Key Management\n\n**User Story:** As a tester, I want to configure PSK keys on the UICC, so that the card can establish secure TLS connections with my test server.\n\n#### Acceptance Criteria\n\n1. WHEN configuring PSK THEN the provisioner SHALL store PSK identity in EF_PSK_ID\n2. WHEN configuring PSK THEN the provisioner SHALL store PSK key in EF_PSK_KEY\n3. WHEN storing PSK THEN the provisioner SHALL support key sizes of 16, 32, and 64 bytes\n4. WHEN generating PSK THEN the provisioner SHALL support random key generation\n5. WHEN importing PSK THEN the provisioner SHALL accept hex string input\n6. WHEN exporting PSK THEN the provisioner SHALL output hex string (for server configuration)\n7. WHEN verifying PSK THEN the provisioner SHALL read back and compare stored values\n8. WHEN PSK files don't exist THEN the provisioner SHALL create them with proper structure\n9. WHEN PSK storage fails THEN the provisioner SHALL report specific error condition\n\n### Requirement 5: Admin Server URL Configuration\n\n**User Story:** As a tester, I want to configure the OTA admin server URL on the UICC, so that the card knows where to connect for OTA sessions.\n\n#### Acceptance Criteria\n\n1. WHEN configuring URL THEN the provisioner SHALL store in EF_ADMIN_URL or equivalent\n2. WHEN storing URL THEN the provisioner SHALL support HTTPS URLs up to 255 bytes\n3. WHEN storing URL THEN the provisioner SHALL encode as TLV with proper tags\n4. WHEN reading URL THEN the provisioner SHALL display current configured URL\n5. WHEN URL is invalid THEN the provisioner SHALL validate format before storing\n6. WHEN URL contains port THEN the provisioner SHALL parse and store correctly\n7. WHEN URL is too long THEN the provisioner SHALL report maximum length exceeded\n\n### Requirement 6: OTA Trigger Configuration\n\n**User Story:** As a tester, I want to configure OTA trigger mechanisms on the UICC, so that the card can respond to push notifications.\n\n#### Acceptance Criteria\n\n1. WHEN configuring trigger THEN the provisioner SHALL support SMS-PP trigger setup\n2. WHEN configuring trigger THEN the provisioner SHALL set TAR (Toolkit Application Reference)\n3. WHEN configuring SMS trigger THEN the provisioner SHALL configure:\n   - Originating address filter\n   - Security parameters (KIc, KID)\n   - Counter settings\n4. WHEN configuring poll trigger THEN the provisioner SHALL set polling interval\n5. WHEN listing triggers THEN the provisioner SHALL show all configured trigger types\n6. WHEN disabling trigger THEN the provisioner SHALL support trigger deactivation\n7. WHEN trigger requires keys THEN the provisioner SHALL prompt for OTA keys (KIc, KID)\n\n### Requirement 7: BIP/CAT Configuration\n\n**User Story:** As a tester, I want to configure BIP (Bearer Independent Protocol) settings on the UICC, so that the card can initiate data connections.\n\n#### Acceptance Criteria\n\n1. WHEN configuring BIP THEN the provisioner SHALL set default bearer parameters\n2. WHEN configuring BIP THEN the provisioner SHALL configure:\n   - Default bearer type (GPRS, EUTRAN, etc.)\n   - APN settings\n   - Buffer sizes\n   - Connection timeout\n3. WHEN enabling BIP THEN the provisioner SHALL verify CAT terminal profile compatibility\n4. WHEN reading BIP config THEN the provisioner SHALL display all BIP parameters\n5. WHEN BIP is not supported THEN the provisioner SHALL report card capability limitation\n\n### Requirement 8: Card Profile Management\n\n**User Story:** As a tester, I want to save and load complete card configurations as profiles, so that I can quickly provision multiple cards with the same settings.\n\n#### Acceptance Criteria\n\n1. WHEN saving profile THEN the provisioner SHALL export all configurable parameters\n2. WHEN saving profile THEN the provisioner SHALL support JSON export format\n3. WHEN saving profile THEN the provisioner SHALL optionally include PSK keys\n4. WHEN loading profile THEN the provisioner SHALL validate before applying\n5. WHEN loading profile THEN the provisioner SHALL show diff with current card state\n6. WHEN applying profile THEN the provisioner SHALL provision all parameters\n7. WHEN comparing profiles THEN the provisioner SHALL highlight differences\n8. WHEN profile is incompatible THEN the provisioner SHALL report specific incompatibilities\n\n### Requirement 9: APDU Command Interface\n\n**User Story:** As a developer, I want to send raw APDU commands to the card, so that I can perform custom operations and debugging.\n\n#### Acceptance Criteria\n\n1. WHEN sending APDU THEN the provisioner SHALL transmit raw command bytes\n2. WHEN receiving response THEN the provisioner SHALL display data and status word\n3. WHEN chaining commands THEN the provisioner SHALL support command scripting\n4. WHEN using macros THEN the provisioner SHALL support named APDU sequences\n5. WHEN logging APDUs THEN the provisioner SHALL record all command/response pairs\n6. WHEN interpreting status THEN the provisioner SHALL decode common SW1SW2 values\n7. WHEN using T=0 THEN the provisioner SHALL handle GET RESPONSE automatically\n8. WHEN using T=1 THEN the provisioner SHALL handle chaining properly\n\n### Requirement 10: Authentication and Key Management\n\n**User Story:** As a tester, I want to authenticate to the card with proper credentials, so that I can access protected areas and perform administrative operations.\n\n#### Acceptance Criteria\n\n1. WHEN authenticating THEN the provisioner SHALL support PIN verification (VERIFY command)\n2. WHEN authenticating THEN the provisioner SHALL support ADM key authentication\n3. WHEN using SCP02 THEN the provisioner SHALL implement proper key derivation\n4. WHEN using SCP03 THEN the provisioner SHALL implement AES-based secure channel\n5. WHEN keys are incorrect THEN the provisioner SHALL report authentication failure\n6. WHEN PIN is blocked THEN the provisioner SHALL report blocked status and remaining tries\n7. WHEN session is established THEN the provisioner SHALL maintain secure channel state\n8. WHEN session expires THEN the provisioner SHALL re-authenticate automatically\n\n### Requirement 11: CLI Integration\n\n**User Story:** As a developer, I want to control provisioning via command line, so that I can automate card preparation workflows.\n\n#### Acceptance Criteria\n\n1. WHEN running `cardlink-provision list` THEN the CLI SHALL display all connected readers and cards\n2. WHEN running `cardlink-provision info <reader>` THEN the CLI SHALL show card details:\n   - ATR and analysis\n   - ICCID, IMSI\n   - Security Domain status\n   - Current PSK/URL configuration\n3. WHEN running `cardlink-provision psk <reader>` THEN the CLI SHALL configure PSK:\n   - `--identity` for PSK identity string\n   - `--key` for PSK key (hex)\n   - `--generate` for random key generation\n   - `--export` to output configured values\n4. WHEN running `cardlink-provision url <reader> <url>` THEN the CLI SHALL set admin URL\n5. WHEN running `cardlink-provision trigger <reader>` THEN the CLI SHALL configure triggers:\n   - `--sms` for SMS-PP trigger setup\n   - `--poll` for polling trigger setup\n   - `--tar` for TAR configuration\n6. WHEN running `cardlink-provision apdu <reader> <hex>` THEN the CLI SHALL send raw APDU\n7. WHEN running `cardlink-provision profile save/load/apply` THEN the CLI SHALL manage profiles\n8. WHEN running `cardlink-provision auth <reader>` THEN the CLI SHALL authenticate:\n   - `--pin` for PIN authentication\n   - `--adm` for ADM key authentication\n   - `--scp02`/`--scp03` for secure channel\n\n### Requirement 12: Event Emission for Integration\n\n**User Story:** As a dashboard developer, I want the provisioner to emit events, so that I can display provisioning status in real-time.\n\n#### Acceptance Criteria\n\n1. WHEN a reader is connected THEN the provisioner SHALL emit `reader_connected` event\n2. WHEN a reader is disconnected THEN the provisioner SHALL emit `reader_disconnected` event\n3. WHEN a card is inserted THEN the provisioner SHALL emit `card_inserted` event with ATR\n4. WHEN a card is removed THEN the provisioner SHALL emit `card_removed` event\n5. WHEN provisioning starts THEN the provisioner SHALL emit `provisioning_started` event\n6. WHEN provisioning completes THEN the provisioner SHALL emit `provisioning_completed` event\n7. WHEN an error occurs THEN the provisioner SHALL emit `provisioning_error` event\n8. WHEN APDU is exchanged THEN the provisioner SHALL emit `apdu_exchange` event\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility**: Separate classes for PC/SC communication, APDU handling, profile management\n- **Modular Design**: Provisioner usable standalone without server or database\n- **Card Abstraction**: Abstract interface to support different card types (UICC, eUICC)\n- **Dependency Injection**: Inject PC/SC context, key providers, event emitter\n\n### Performance\n\n- **Reader detection**: Detect connected readers within 2 seconds\n- **Card detection**: Detect card insertion/removal within 2 seconds\n- **APDU latency**: Single APDU exchange within 1 second\n- **Profile application**: Complete profile provisioning within 30 seconds\n\n### Compatibility\n\n- **PC/SC Readers**: Support standard PC/SC compliant readers (ACR, Omnikey, etc.)\n- **Card Types**: UICC cards with GlobalPlatform support\n- **Operating Systems**: Linux (pcscd), macOS (native), Windows (WinSCard)\n- **PC/SC Lite**: Version 1.8+ on Linux\n\n### Reliability\n\n- **Transaction handling**: Rollback on provisioning failure\n- **Card state preservation**: Never leave card in inconsistent state\n- **Connection recovery**: Handle card removal during operation gracefully\n- **Error reporting**: Clear, actionable error messages for all failure modes\n\n### Security\n\n- **Key handling**: Never log sensitive keys in plaintext\n- **Secure memory**: Clear key buffers after use\n- **ADM protection**: Warn before operations that could brick the card\n- **PIN attempts**: Display remaining tries before authentication\n",
  "fileStats": {
    "size": 13534,
    "lines": 257,
    "lastModified": "2025-11-25T11:32:32.923Z"
  },
  "comments": []
}