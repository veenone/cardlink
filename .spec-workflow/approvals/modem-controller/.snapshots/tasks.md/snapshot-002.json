{
  "id": "snapshot_1764070272730_w3bgmi8ko",
  "approvalId": "approval_1764070086959_h20xoxgwy",
  "approvalTitle": "Modem Controller Tasks Document",
  "version": 2,
  "timestamp": "2025-11-25T11:31:12.730Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Implementation Tasks: Modem Controller\n\n## Task 1: Project Setup and Core Infrastructure\n\n### Task 1.1: Create Modem Module Structure\n- [ ] Create `src/cardlink/modem/` directory structure\n- [ ] Create `__init__.py` with public API exports\n- [ ] Create `models.py` with data models\n- [ ] Create `exceptions.py` with custom exceptions\n- [ ] Create `vendors/` subdirectory for vendor implementations\n\n**Files to create:**\n- `src/cardlink/modem/__init__.py`\n- `src/cardlink/modem/models.py`\n- `src/cardlink/modem/exceptions.py`\n- `src/cardlink/modem/vendors/__init__.py`\n\n### Task 1.2: Define Data Models\n- [ ] Implement ModemProfile dataclass\n- [ ] Implement SIMProfile dataclass\n- [ ] Implement NetworkProfile dataclass\n- [ ] Implement FullModemProfile dataclass\n- [ ] Implement ATResponse dataclass\n- [ ] Implement ATResult enum\n- [ ] Implement URCEvent dataclass\n- [ ] Implement BIPEvent dataclass\n- [ ] Implement PortInfo dataclass\n\n**Files to modify:**\n- `src/cardlink/modem/models.py`\n\n### Task 1.3: Define Custom Exceptions\n- [ ] Implement ModemControllerError base exception\n- [ ] Implement ModemNotFoundError\n- [ ] Implement SerialPortError\n- [ ] Implement ATCommandError\n- [ ] Implement ATTimeoutError\n- [ ] Implement CMEError with error code lookup\n- [ ] Implement CMSError with error code lookup\n\n**Files to modify:**\n- `src/cardlink/modem/exceptions.py`\n\n### Task 1.4: Add Dependencies\n- [ ] Add `pyserial` to pyproject.toml\n- [ ] Create optional dependency group `[modem]`\n\n**Files to modify:**\n- `pyproject.toml`\n\n---\n\n## Task 2: Serial Client Implementation\n\n### Task 2.1: Implement SerialClient Core\n- [ ] Create `serial_client.py` with SerialClient class\n- [ ] Implement constructor with port, baudrate, timeout\n- [ ] Store pyserial Serial instance\n\n**Files to create:**\n- `src/cardlink/modem/serial_client.py`\n\n### Task 2.2: Implement Open/Close\n- [ ] Implement `open()` async method\n- [ ] Configure serial port settings\n- [ ] Implement `close()` async method\n- [ ] Implement `is_open()` property\n\n**Files to modify:**\n- `src/cardlink/modem/serial_client.py`\n\n### Task 2.3: Implement Read/Write\n- [ ] Implement `write(data)` async method\n- [ ] Implement `read(size)` async method\n- [ ] Implement `read_line(timeout)` async method\n- [ ] Implement `read_until(terminator, timeout)` async method\n- [ ] Handle timeout exceptions\n\n**Files to modify:**\n- `src/cardlink/modem/serial_client.py`\n\n### Task 2.4: Implement Port Listing\n- [ ] Implement `list_ports()` static method\n- [ ] Use pyserial.tools.list_ports\n- [ ] Parse port info into PortInfo dataclass\n- [ ] Extract USB VID:PID, manufacturer, product\n\n**Files to modify:**\n- `src/cardlink/modem/serial_client.py`\n\n### Task 2.5: Write SerialClient Unit Tests\n- [ ] Test port listing\n- [ ] Test open/close\n- [ ] Test read/write with mock serial\n\n**Files to create:**\n- `tests/unit/modem/test_serial_client.py`\n\n---\n\n## Task 3: AT Interface Implementation\n\n### Task 3.1: Implement ATInterface Core\n- [ ] Create `at_interface.py` with ATInterface class\n- [ ] Initialize with SerialClient\n- [ ] Store URC handlers dictionary\n- [ ] Implement command queue for serialization\n\n**Files to create:**\n- `src/cardlink/modem/at_interface.py`\n\n### Task 3.2: Implement send_command\n- [ ] Implement `send_command(command, timeout, expect_response)` method\n- [ ] Format command with \\r\\n terminator\n- [ ] Write to serial port\n- [ ] Read response until OK, ERROR, or timeout\n- [ ] Parse response into ATResponse\n\n**Files to modify:**\n- `src/cardlink/modem/at_interface.py`\n\n### Task 3.3: Implement Response Parsing\n- [ ] Detect OK result\n- [ ] Detect ERROR result\n- [ ] Detect +CME ERROR with code parsing\n- [ ] Detect +CMS ERROR with code parsing\n- [ ] Extract data lines between command echo and result\n\n**Files to modify:**\n- `src/cardlink/modem/at_interface.py`\n\n### Task 3.4: Implement send_raw\n- [ ] Implement `send_raw(data)` method for PDU mode\n- [ ] Write raw bytes without processing\n\n**Files to modify:**\n- `src/cardlink/modem/at_interface.py`\n\n### Task 3.5: Implement URC Monitoring\n- [ ] Implement `start_urc_monitoring()` method\n- [ ] Create background task/thread for reading\n- [ ] Detect URC patterns in incoming data\n- [ ] Queue URCs for processing\n- [ ] Implement `stop_urc_monitoring()` method\n\n**Files to modify:**\n- `src/cardlink/modem/at_interface.py`\n\n### Task 3.6: Implement URC Handler Registration\n- [ ] Implement `register_urc_handler(pattern, callback)` method\n- [ ] Match URCs against registered patterns\n- [ ] Call appropriate callbacks\n\n**Files to modify:**\n- `src/cardlink/modem/at_interface.py`\n\n### Task 3.7: Write ATInterface Unit Tests\n- [ ] Test command formatting\n- [ ] Test OK response parsing\n- [ ] Test ERROR response parsing\n- [ ] Test CME ERROR parsing\n- [ ] Test multi-line response parsing\n\n**Files to create:**\n- `tests/unit/modem/test_at_interface.py`\n\n---\n\n## Task 4: URC Parser Implementation\n\n### Task 4.1: Implement URCParser Core\n- [ ] Create `urc_parser.py` with URCParser class\n- [ ] Define common URC patterns dictionary\n- [ ] Initialize pattern matchers\n\n**Files to create:**\n- `src/cardlink/modem/urc_parser.py`\n\n### Task 4.2: Implement URC Detection\n- [ ] Implement `is_urc(line)` method\n- [ ] Check if line starts with + or other URC indicators\n- [ ] Implement `parse(line)` method\n- [ ] Match against known patterns\n- [ ] Extract data from URC\n\n**Files to modify:**\n- `src/cardlink/modem/urc_parser.py`\n\n### Task 4.3: Implement Pattern Registration\n- [ ] Implement `register_pattern(pattern, event_type, parser)` method\n- [ ] Support custom URC patterns\n\n**Files to modify:**\n- `src/cardlink/modem/urc_parser.py`\n\n### Task 4.4: Implement Common URC Parsers\n- [ ] Implement CREG parser (network registration)\n- [ ] Implement CEREG parser (EPS registration)\n- [ ] Implement CPIN parser (SIM status)\n- [ ] Implement QSTK parser (STK events)\n- [ ] Implement QIND parser (Quectel indications)\n\n**Files to modify:**\n- `src/cardlink/modem/urc_parser.py`\n\n### Task 4.5: Write URCParser Unit Tests\n- [ ] Test URC detection\n- [ ] Test CREG parsing\n- [ ] Test CEREG parsing\n- [ ] Test QSTK parsing\n\n**Files to create:**\n- `tests/unit/modem/test_urc_parser.py`\n\n---\n\n## Task 5: Modem Manager Implementation\n\n### Task 5.1: Implement ModemManager Core\n- [ ] Create `modem_manager.py` with ModemManager class\n- [ ] Initialize with EventEmitter\n- [ ] Store discovered modems registry\n- [ ] Configure polling interval\n\n**Files to create:**\n- `src/cardlink/modem/modem_manager.py`\n\n### Task 5.2: Implement Modem Scanning\n- [ ] Implement `scan_modems()` method\n- [ ] List serial ports\n- [ ] Filter by known USB VID:PID\n- [ ] Identify modem via ATI command\n- [ ] Create ModemInfo for each detected modem\n\n**Files to modify:**\n- `src/cardlink/modem/modem_manager.py`\n\n### Task 5.3: Implement Modem Identification\n- [ ] Implement `_identify_modem(port)` method\n- [ ] Open serial port temporarily\n- [ ] Send ATI command\n- [ ] Parse response to determine vendor/model\n- [ ] Create appropriate vendor modem instance\n\n**Files to modify:**\n- `src/cardlink/modem/modem_manager.py`\n\n### Task 5.4: Implement Background Monitoring\n- [ ] Implement `start_monitoring()` async method\n- [ ] Create background task for polling\n- [ ] Detect new modem connections\n- [ ] Detect modem disconnections\n- [ ] Emit events on changes\n\n**Files to modify:**\n- `src/cardlink/modem/modem_manager.py`\n\n### Task 5.5: Implement Stop Monitoring\n- [ ] Implement `stop_monitoring()` method\n- [ ] Cancel background task\n- [ ] Clean up resources\n\n**Files to modify:**\n- `src/cardlink/modem/modem_manager.py`\n\n### Task 5.6: Write ModemManager Unit Tests\n- [ ] Test modem scanning with mock ports\n- [ ] Test modem identification\n- [ ] Test connection/disconnection detection\n\n**Files to create:**\n- `tests/unit/modem/test_modem_manager.py`\n\n---\n\n## Task 6: Modem Information and Profiling\n\n### Task 6.1: Implement ModemInfo Core\n- [ ] Create `modem_info.py` with ModemInfo class\n- [ ] Initialize with ATInterface\n- [ ] Implement caching with TTL\n\n**Files to create:**\n- `src/cardlink/modem/modem_info.py`\n\n### Task 6.2: Implement Modem Properties Retrieval\n- [ ] Implement `get_modem_info()` method\n- [ ] Query AT+CGMI (manufacturer)\n- [ ] Query AT+CGMM (model)\n- [ ] Query AT+CGMR (firmware)\n- [ ] Query AT+CGSN (IMEI)\n- [ ] Build ModemProfile dataclass\n\n**Files to modify:**\n- `src/cardlink/modem/modem_info.py`\n\n### Task 6.3: Implement SIM Information Retrieval\n- [ ] Implement `get_sim_info()` method\n- [ ] Query AT+CPIN? (status)\n- [ ] Query AT+QCCID or AT+CCID (ICCID)\n- [ ] Query AT+CIMI (IMSI)\n- [ ] Query AT+CNUM (MSISDN)\n- [ ] Build SIMProfile dataclass\n\n**Files to modify:**\n- `src/cardlink/modem/modem_info.py`\n\n### Task 6.4: Implement Network Information Retrieval\n- [ ] Implement `get_network_info()` method\n- [ ] Query AT+CREG? / AT+CEREG? (registration)\n- [ ] Query AT+COPS? (operator)\n- [ ] Query AT+CSQ / AT+QCSQ (signal)\n- [ ] Query AT+CGDCONT? (APN)\n- [ ] Build NetworkProfile dataclass\n\n**Files to modify:**\n- `src/cardlink/modem/modem_info.py`\n\n### Task 6.5: Implement Full Profile and Export\n- [ ] Implement `get_full_profile()` method\n- [ ] Implement `export_json()` method\n- [ ] Implement profile comparison\n\n**Files to modify:**\n- `src/cardlink/modem/modem_info.py`\n\n### Task 6.6: Write ModemInfo Unit Tests\n- [ ] Test modem info parsing\n- [ ] Test SIM info parsing\n- [ ] Test network info parsing\n- [ ] Test JSON export\n\n**Files to create:**\n- `tests/unit/modem/test_modem_info.py`\n\n---\n\n## Task 7: BIP Monitoring\n\n### Task 7.1: Implement BIPMonitor Core\n- [ ] Create `bip_monitor.py` with BIPMonitor class\n- [ ] Initialize with ATInterface and EventEmitter\n- [ ] Store running state\n\n**Files to create:**\n- `src/cardlink/modem/bip_monitor.py`\n\n### Task 7.2: Implement STK Notification Enable\n- [ ] Implement `enable_stk_notifications()` method\n- [ ] Send AT+QSTK=1 for Quectel\n- [ ] Send appropriate command for other vendors\n\n**Files to modify:**\n- `src/cardlink/modem/bip_monitor.py`\n\n### Task 7.3: Implement Start/Stop Monitoring\n- [ ] Implement `start()` async method\n- [ ] Enable STK notifications\n- [ ] Register URC handlers for STK events\n- [ ] Implement `stop()` method\n- [ ] Unregister handlers\n\n**Files to modify:**\n- `src/cardlink/modem/bip_monitor.py`\n\n### Task 7.4: Implement STK Event Processing\n- [ ] Implement `_process_stk_event(urc_data)` method\n- [ ] Parse proactive command TLV\n- [ ] Identify BIP commands (OPEN_CHANNEL, SEND_DATA, etc.)\n- [ ] Extract parameters\n- [ ] Emit BIP events\n\n**Files to modify:**\n- `src/cardlink/modem/bip_monitor.py`\n\n### Task 7.5: Write BIPMonitor Unit Tests\n- [ ] Test STK enable command\n- [ ] Test OPEN_CHANNEL event parsing\n- [ ] Test SEND_DATA event parsing\n\n**Files to create:**\n- `tests/unit/modem/test_bip_monitor.py`\n\n---\n\n## Task 8: SMS Trigger Implementation\n\n### Task 8.1: Implement SMSTrigger Core\n- [ ] Create `sms_trigger.py` with SMSTrigger class\n- [ ] Initialize with ATInterface\n- [ ] Define trigger templates\n\n**Files to create:**\n- `src/cardlink/modem/sms_trigger.py`\n\n### Task 8.2: Implement PDU Mode Configuration\n- [ ] Implement `configure_pdu_mode()` method\n- [ ] Send AT+CMGF=0\n- [ ] Verify PDU mode set\n\n**Files to modify:**\n- `src/cardlink/modem/sms_trigger.py`\n\n### Task 8.3: Implement PDU Sending\n- [ ] Implement `_send_pdu(pdu)` method\n- [ ] Calculate TPDU length\n- [ ] Send AT+CMGS=<length>\n- [ ] Wait for > prompt\n- [ ] Send PDU hex + Ctrl+Z\n- [ ] Parse +CMGS response\n\n**Files to modify:**\n- `src/cardlink/modem/sms_trigger.py`\n\n### Task 8.4: Implement Trigger Templates\n- [ ] Define TriggerTemplate dataclass\n- [ ] Create OTA trigger template\n- [ ] Implement `send_trigger(template, params)` method\n- [ ] Implement `send_raw_pdu(pdu)` method\n\n**Files to modify:**\n- `src/cardlink/modem/sms_trigger.py`\n\n### Task 8.5: Write SMSTrigger Unit Tests\n- [ ] Test PDU mode configuration\n- [ ] Test AT+CMGS command formatting\n- [ ] Test response parsing\n\n**Files to create:**\n- `tests/unit/modem/test_sms_trigger.py`\n\n---\n\n## Task 9: Network Manager Implementation\n\n### Task 9.1: Implement NetworkManager Core\n- [ ] Create `network_manager.py` with NetworkManager class\n- [ ] Initialize with ATInterface\n\n**Files to create:**\n- `src/cardlink/modem/network_manager.py`\n\n### Task 9.2: Implement APN Configuration\n- [ ] Implement `configure_apn(apn, username, password, auth_type)` method\n- [ ] Send AT+CGDCONT for PDP context\n- [ ] Send AT+CGAUTH for authentication\n\n**Files to modify:**\n- `src/cardlink/modem/network_manager.py`\n\n### Task 9.3: Implement PDP Activation\n- [ ] Implement `activate_pdp(cid)` method using AT+CGACT\n- [ ] Implement `deactivate_pdp(cid)` method\n- [ ] Implement `get_ip_address(cid)` via AT+CGPADDR\n\n**Files to modify:**\n- `src/cardlink/modem/network_manager.py`\n\n### Task 9.4: Implement Registration Check\n- [ ] Implement `check_registration()` method\n- [ ] Query AT+CREG? and AT+CEREG?\n- [ ] Return RegistrationStatus\n\n**Files to modify:**\n- `src/cardlink/modem/network_manager.py`\n\n### Task 9.5: Implement Ping\n- [ ] Implement `ping(host, count)` method\n- [ ] Send AT+QPING for Quectel\n- [ ] Parse ping results\n\n**Files to modify:**\n- `src/cardlink/modem/network_manager.py`\n\n### Task 9.6: Write NetworkManager Unit Tests\n- [ ] Test APN configuration commands\n- [ ] Test PDP activation commands\n- [ ] Test registration parsing\n\n**Files to create:**\n- `tests/unit/modem/test_network_manager.py`\n\n---\n\n## Task 10: Vendor-Specific Implementation\n\n### Task 10.1: Implement Base Modem Class\n- [ ] Create `vendors/base.py` with Modem base class\n- [ ] Define abstract methods for vendor-specific operations\n- [ ] Implement common AT command methods\n\n**Files to create:**\n- `src/cardlink/modem/vendors/base.py`\n\n### Task 10.2: Implement QuectelModem\n- [ ] Create `vendors/quectel.py` with QuectelModem class\n- [ ] Implement `get_detailed_signal()` via AT+QCSQ\n- [ ] Implement `configure_bands()` via AT+QCFG=\"band\"\n- [ ] Implement `enable_stk()` via AT+QSTK=1\n- [ ] Implement `get_qeng_info()` via AT+QENG\n\n**Files to create:**\n- `src/cardlink/modem/vendors/quectel.py`\n\n### Task 10.3: Implement Quectel Signal Parsing\n- [ ] Parse AT+QCSQ response for RSSI, RSRP, SINR, RSRQ\n- [ ] Handle different network types (LTE, NR5G)\n\n**Files to modify:**\n- `src/cardlink/modem/vendors/quectel.py`\n\n### Task 10.4: Write QuectelModem Unit Tests\n- [ ] Test signal info parsing\n- [ ] Test band configuration\n- [ ] Test STK enable\n\n**Files to create:**\n- `tests/unit/modem/test_quectel.py`\n\n---\n\n## Task 11: QXDM Interface (Optional)\n\n### Task 11.1: Implement QXDMInterface Core\n- [ ] Create `qxdm_interface.py` with QXDMInterface class\n- [ ] Implement DM port detection\n\n**Files to create:**\n- `src/cardlink/modem/qxdm_interface.py`\n\n### Task 11.2: Implement Connect/Disconnect\n- [ ] Implement `connect()` method\n- [ ] Implement `disconnect()` method\n- [ ] Implement `is_available()` method\n\n**Files to modify:**\n- `src/cardlink/modem/qxdm_interface.py`\n\n### Task 11.3: Implement Logging Control\n- [ ] Implement `start_logging(log_codes)` method\n- [ ] Implement `stop_logging()` method\n- [ ] Implement `export_log(filepath, format)` method\n\n**Files to modify:**\n- `src/cardlink/modem/qxdm_interface.py`\n\n### Task 11.4: Implement DM Port Detection\n- [ ] Implement `get_dm_port()` method\n- [ ] Map USB interface to port function\n- [ ] Identify DM port from Quectel interface layout\n\n**Files to modify:**\n- `src/cardlink/modem/qxdm_interface.py`\n\n---\n\n## Task 12: Modem Controller Main Class\n\n### Task 12.1: Implement ModemController Core\n- [ ] Create `controller.py` with ModemController class\n- [ ] Initialize ModemManager, EventEmitter\n- [ ] Implement `discover_modems()` method\n\n**Files to create:**\n- `src/cardlink/modem/controller.py`\n\n### Task 12.2: Implement Modem Access\n- [ ] Implement `get_modem(port)` method\n- [ ] Return fully configured Modem instance\n- [ ] Cache modem instances\n\n**Files to modify:**\n- `src/cardlink/modem/controller.py`\n\n### Task 12.3: Implement Event Callbacks\n- [ ] Implement `on_modem_connected(callback)` method\n- [ ] Implement `on_modem_disconnected(callback)` method\n- [ ] Wire to EventEmitter\n\n**Files to modify:**\n- `src/cardlink/modem/controller.py`\n\n### Task 12.4: Write ModemController Unit Tests\n- [ ] Test modem discovery\n- [ ] Test modem access\n- [ ] Test event callbacks\n\n**Files to create:**\n- `tests/unit/modem/test_controller.py`\n\n---\n\n## Task 13: CLI Integration\n\n### Task 13.1: Implement cardlink-modem CLI\n- [ ] Create `src/cardlink/cli/modem.py` with Click commands\n- [ ] Implement `list` command to show connected modems\n- [ ] Display port, manufacturer, model\n\n**Files to create:**\n- `src/cardlink/cli/modem.py`\n\n### Task 13.2: Implement info Command\n- [ ] Implement `info <modem>` command\n- [ ] Add `--modem` flag for modem info only\n- [ ] Add `--sim` flag for SIM info only\n- [ ] Add `--network` flag for network info only\n- [ ] Add `--all` flag (default)\n- [ ] Add `--json` flag for JSON output\n\n**Files to modify:**\n- `src/cardlink/cli/modem.py`\n\n### Task 13.3: Implement at Command\n- [ ] Implement `at <modem> <command>` command\n- [ ] Send AT command\n- [ ] Display response\n\n**Files to modify:**\n- `src/cardlink/cli/modem.py`\n\n### Task 13.4: Implement trigger Command\n- [ ] Implement `trigger <modem>` command\n- [ ] Add `--template` option\n- [ ] Add `--pdu` option for raw PDU\n- [ ] Display result\n\n**Files to modify:**\n- `src/cardlink/cli/modem.py`\n\n### Task 13.5: Implement monitor Command\n- [ ] Implement `monitor <modem>` command\n- [ ] Start BIP/URC monitoring\n- [ ] Display events in real-time\n- [ ] Handle Ctrl+C to stop\n\n**Files to modify:**\n- `src/cardlink/cli/modem.py`\n\n### Task 13.6: Implement diag Command\n- [ ] Implement `diag <modem>` command\n- [ ] Start QXDM capture\n- [ ] Add `--output` for file path\n- [ ] Handle Ctrl+C to stop and export\n\n**Files to modify:**\n- `src/cardlink/cli/modem.py`\n\n### Task 13.7: Implement profile Commands\n- [ ] Implement `profile save/load/compare/list` commands\n\n**Files to modify:**\n- `src/cardlink/cli/modem.py`\n\n### Task 13.8: Write CLI Integration Tests\n- [ ] Test `cardlink-modem list`\n- [ ] Test `cardlink-modem info`\n- [ ] Test `cardlink-modem at`\n\n**Files to create:**\n- `tests/integration/test_modem_cli.py`\n\n---\n\n## Task 14: Integration Testing\n\n### Task 14.1: Write Modem Integration Tests\n- [ ] Test modem discovery with real modem\n- [ ] Test ATI command\n- [ ] Test SIM status query\n\n**Files to create:**\n- `tests/integration/test_modem_device.py`\n\n### Task 14.2: Write Network Integration Tests\n- [ ] Test network registration query\n- [ ] Test signal strength query\n- [ ] Test APN configuration\n\n**Files to create:**\n- `tests/integration/test_modem_network.py`\n\n---\n\n## Summary\n\n| Task Group | Tasks | Description |\n|------------|-------|-------------|\n| Task 1 | 1.1 - 1.4 | Project setup and infrastructure |\n| Task 2 | 2.1 - 2.5 | Serial client implementation |\n| Task 3 | 3.1 - 3.7 | AT interface implementation |\n| Task 4 | 4.1 - 4.5 | URC parser implementation |\n| Task 5 | 5.1 - 5.6 | Modem manager implementation |\n| Task 6 | 6.1 - 6.6 | Modem information and profiling |\n| Task 7 | 7.1 - 7.5 | BIP monitoring |\n| Task 8 | 8.1 - 8.5 | SMS trigger implementation |\n| Task 9 | 9.1 - 9.6 | Network manager implementation |\n| Task 10 | 10.1 - 10.4 | Vendor-specific (Quectel) |\n| Task 11 | 11.1 - 11.4 | QXDM interface (optional) |\n| Task 12 | 12.1 - 12.4 | Modem controller main class |\n| Task 13 | 13.1 - 13.8 | CLI integration |\n| Task 14 | 14.1 - 14.2 | Integration testing |\n\n**Total: 14 task groups, 63 subtasks**\n",
  "fileStats": {
    "size": 19503,
    "lines": 705,
    "lastModified": "2025-11-25T11:27:01.062Z"
  },
  "comments": []
}