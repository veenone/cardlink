{
  "id": "snapshot_1764067416725_ry6hlud7i",
  "approvalId": "approval_1764067416707_i8kipm4sz",
  "approvalTitle": "PSK-TLS Server Tasks Document",
  "version": 1,
  "timestamp": "2025-11-25T10:43:36.725Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Implementation Tasks: PSK-TLS Admin Server\n\n## Task 1: Project Setup and Configuration\n\n### Task 1.1: Create Server Module Structure\n- [ ] Create `src/cardlink/server/` directory structure\n- [ ] Create `__init__.py` with public API exports\n- [ ] Create `config.py` with ServerConfig, CipherConfig dataclasses\n- [ ] Create `models.py` with TLSSessionInfo, Session, APDUExchange, SessionState, CloseReason, HandshakeState, TLSAlert\n\n**Files to create:**\n- `src/cardlink/server/__init__.py`\n- `src/cardlink/server/config.py`\n- `src/cardlink/server/models.py`\n\n### Task 1.2: Add Server Dependencies\n- [ ] Add `sslpsk3` to pyproject.toml dependencies\n- [ ] Add `pyyaml` to pyproject.toml dependencies\n- [ ] Create optional dependency group `[server]` for server-specific packages\n- [ ] Verify sslpsk3 installation works on target platform\n\n**Files to modify:**\n- `pyproject.toml`\n\n---\n\n## Task 2: Key Store Implementation\n\n### Task 2.1: Implement KeyStore Abstract Base Class\n- [ ] Create `key_store.py` with KeyStore ABC\n- [ ] Define `get_key(identity: str) -> Optional[bytes]` abstract method\n- [ ] Define `identity_exists(identity: str) -> bool` abstract method\n- [ ] Add docstrings with usage examples\n\n**Files to create:**\n- `src/cardlink/server/key_store.py`\n\n### Task 2.2: Implement FileKeyStore\n- [ ] Implement FileKeyStore class extending KeyStore\n- [ ] Load keys from YAML file on initialization\n- [ ] Parse hex-encoded keys to bytes\n- [ ] Cache keys in memory after load\n- [ ] Add file validation and error handling for malformed files\n- [ ] Never log key values in plaintext\n\n**Files to modify:**\n- `src/cardlink/server/key_store.py`\n\n### Task 2.3: Implement DatabaseKeyStore\n- [ ] Implement DatabaseKeyStore class extending KeyStore\n- [ ] Integrate with CardRepository from database layer\n- [ ] Query card profiles by PSK identity\n- [ ] Handle database connection errors gracefully\n\n**Files to modify:**\n- `src/cardlink/server/key_store.py`\n\n### Task 2.4: Write KeyStore Unit Tests\n- [ ] Test FileKeyStore with valid YAML file\n- [ ] Test FileKeyStore with missing file\n- [ ] Test FileKeyStore with malformed YAML\n- [ ] Test key retrieval for existing identity\n- [ ] Test key retrieval for non-existent identity\n- [ ] Create MockKeyStore for other component tests\n\n**Files to create:**\n- `tests/unit/test_key_store.py`\n\n---\n\n## Task 3: Event Emitter Implementation\n\n### Task 3.1: Implement EventEmitter\n- [ ] Create `event_emitter.py` with EventEmitter class\n- [ ] Implement `emit(event_type: str, data: Dict)` method\n- [ ] Implement `subscribe(event_type: str, callback: Callable) -> str` method\n- [ ] Implement `unsubscribe(subscription_id: str)` method\n- [ ] Use thread-safe queue for event distribution\n- [ ] Support wildcard subscriptions for all events\n\n**Files to create:**\n- `src/cardlink/server/event_emitter.py`\n\n### Task 3.2: Define Event Types and Schemas\n- [ ] Define all 11 event types as constants\n- [ ] Create Pydantic schemas for event data validation\n- [ ] Document event data fields for each type\n\n**Files to modify:**\n- `src/cardlink/server/event_emitter.py`\n\n### Task 3.3: Write EventEmitter Unit Tests\n- [ ] Test event emission to single subscriber\n- [ ] Test event emission to multiple subscribers\n- [ ] Test subscription and unsubscription\n- [ ] Test thread safety with concurrent emissions\n- [ ] Create MockEventEmitter for other component tests\n\n**Files to create:**\n- `tests/unit/test_event_emitter.py`\n\n---\n\n## Task 4: TLS Handler Implementation\n\n### Task 4.1: Implement CipherConfig\n- [ ] Create CipherConfig dataclass in config.py\n- [ ] Define production cipher suites (AES-CBC-SHA256/384)\n- [ ] Define legacy cipher suites (AES-CBC-SHA)\n- [ ] Define testing cipher suites (NULL-SHA, NULL-SHA256)\n- [ ] Add enable_legacy and enable_null_ciphers flags\n\n**Files to modify:**\n- `src/cardlink/server/config.py`\n\n### Task 4.2: Implement TLSHandler Core\n- [ ] Create `tls_handler.py` with TLSHandler class\n- [ ] Implement `create_ssl_context()` method\n- [ ] Configure sslpsk3 with PSK callback\n- [ ] Set allowed cipher suites based on CipherConfig\n- [ ] Set TLS 1.2 as protocol version\n\n**Files to create:**\n- `src/cardlink/server/tls_handler.py`\n\n### Task 4.3: Implement PSK Callback\n- [ ] Implement PSK identity callback function\n- [ ] Look up key from KeyStore\n- [ ] Return None for unknown identities (triggers handshake failure)\n- [ ] Log PSK identity (but not key value)\n\n**Files to modify:**\n- `src/cardlink/server/tls_handler.py`\n\n### Task 4.4: Implement wrap_socket Method\n- [ ] Implement `wrap_socket(sock, client_addr)` method\n- [ ] Perform TLS handshake with timeout\n- [ ] Track handshake duration for metrics\n- [ ] Return TLSSessionInfo with cipher suite, identity, timing\n- [ ] Handle handshake exceptions\n\n**Files to modify:**\n- `src/cardlink/server/tls_handler.py`\n\n### Task 4.5: Implement NULL Cipher Warning\n- [ ] Log warning at initialization when NULL ciphers enabled\n- [ ] Log each connection using NULL cipher suite\n- [ ] Include prominent \"UNENCRYPTED TRAFFIC\" message\n\n**Files to modify:**\n- `src/cardlink/server/tls_handler.py`\n\n### Task 4.6: Implement Handshake Error Handling\n- [ ] Implement `handle_handshake_error()` method\n- [ ] Track partial handshake state (HandshakeState dataclass)\n- [ ] Map exceptions to appropriate TLS alerts\n- [ ] Log partial state on timeout\n\n**Files to modify:**\n- `src/cardlink/server/tls_handler.py`\n\n### Task 4.7: Write TLSHandler Unit Tests\n- [ ] Test SSL context creation with default ciphers\n- [ ] Test SSL context creation with legacy ciphers enabled\n- [ ] Test SSL context creation with NULL ciphers enabled\n- [ ] Test PSK callback with valid identity\n- [ ] Test PSK callback with invalid identity\n- [ ] Test handshake error mapping\n\n**Files to create:**\n- `tests/unit/test_tls_handler.py`\n\n---\n\n## Task 5: Session Manager Implementation\n\n### Task 5.1: Implement SessionManager Core\n- [ ] Create `session_manager.py` with SessionManager class\n- [ ] Implement `create_session()` method with UUID generation\n- [ ] Implement `get_session()` method\n- [ ] Implement `close_session()` method with summary generation\n- [ ] Store sessions in thread-safe dictionary\n\n**Files to create:**\n- `src/cardlink/server/session_manager.py`\n\n### Task 5.2: Implement Session State Machine\n- [ ] Define state transitions (HANDSHAKING → CONNECTED → ACTIVE → CLOSED)\n- [ ] Implement state change method with validation\n- [ ] Emit events on state transitions\n- [ ] Prevent invalid transitions\n\n**Files to modify:**\n- `src/cardlink/server/session_manager.py`\n\n### Task 5.3: Implement Session Timeout\n- [ ] Create background timer thread for expiration checking\n- [ ] Run expiration check every 30 seconds\n- [ ] Implement `cleanup_expired()` method\n- [ ] Close sessions exceeding timeout (default 300s)\n- [ ] Emit session_ended event with timeout reason\n\n**Files to modify:**\n- `src/cardlink/server/session_manager.py`\n\n### Task 5.4: Implement APDU Exchange Tracking\n- [ ] Add method to record APDU exchange in session\n- [ ] Track command, response, timestamp, duration\n- [ ] Increment command_count\n- [ ] Update last_activity timestamp\n\n**Files to modify:**\n- `src/cardlink/server/session_manager.py`\n\n### Task 5.5: Write SessionManager Unit Tests\n- [ ] Test session creation with unique IDs\n- [ ] Test session retrieval\n- [ ] Test state transitions (valid and invalid)\n- [ ] Test session timeout expiration\n- [ ] Test APDU exchange tracking\n- [ ] Test concurrent session access\n\n**Files to create:**\n- `tests/unit/test_session_manager.py`\n\n---\n\n## Task 6: Error Handler Implementation\n\n### Task 6.1: Implement ErrorHandler Core\n- [ ] Create `error_handler.py` with ErrorHandler class\n- [ ] Initialize with EventEmitter and MetricsCollector\n- [ ] Configure mismatch threshold and window\n\n**Files to create:**\n- `src/cardlink/server/error_handler.py`\n\n### Task 6.2: Implement Connection Interruption Handling\n- [ ] Implement `handle_connection_interrupted()` method\n- [ ] Log session_id, last_command, timestamp\n- [ ] Emit `connection_interrupted` event\n- [ ] Trigger session cleanup\n\n**Files to modify:**\n- `src/cardlink/server/error_handler.py`\n\n### Task 6.3: Implement PSK Mismatch Handling\n- [ ] Implement `handle_psk_mismatch()` method\n- [ ] Implement MismatchTracker for per-IP tracking\n- [ ] Log identity and client_addr (NOT key values)\n- [ ] Emit `psk_mismatch` event\n- [ ] Log warning when multiple mismatches from same source in window\n- [ ] Return TLS Alert 51 (decrypt_error)\n\n**Files to modify:**\n- `src/cardlink/server/error_handler.py`\n\n### Task 6.4: Implement Handshake Interruption Handling\n- [ ] Implement `handle_handshake_interrupted()` method\n- [ ] Log client_addr, partial_state, reason\n- [ ] Emit `handshake_interrupted` event\n- [ ] Log as \"potential network issue\" if only ClientHello received\n\n**Files to modify:**\n- `src/cardlink/server/error_handler.py`\n\n### Task 6.5: Implement Error Rate Monitoring\n- [ ] Implement `check_error_rate()` method\n- [ ] Track error counts over rolling window\n- [ ] Emit `high_error_rate` event when threshold exceeded\n- [ ] Include error_type, rate, threshold in event\n\n**Files to modify:**\n- `src/cardlink/server/error_handler.py`\n\n### Task 6.6: Write ErrorHandler Unit Tests\n- [ ] Test connection interruption handling\n- [ ] Test PSK mismatch handling with single occurrence\n- [ ] Test PSK mismatch warning with multiple occurrences\n- [ ] Test handshake interruption with various partial states\n- [ ] Test error rate threshold detection\n\n**Files to create:**\n- `tests/unit/test_error_handler.py`\n\n---\n\n## Task 7: HTTP Handler Implementation\n\n### Task 7.1: Implement HTTPHandler Core\n- [ ] Create `http_handler.py` with HTTPHandler class\n- [ ] Define CONTENT_TYPE constant for GP Admin protocol\n- [ ] Initialize with GPCommandProcessor\n\n**Files to create:**\n- `src/cardlink/server/http_handler.py`\n\n### Task 7.2: Implement Request Parsing\n- [ ] Implement `parse_admin_request()` method\n- [ ] Parse HTTP headers from raw bytes\n- [ ] Validate Content-Type header\n- [ ] Return 415 Unsupported Media Type for invalid content-type\n- [ ] Extract body as GP Admin request\n\n**Files to modify:**\n- `src/cardlink/server/http_handler.py`\n\n### Task 7.3: Implement APDU Extraction\n- [ ] Parse GP Admin request body\n- [ ] Extract APDU commands from request\n- [ ] Handle multiple APDUs in single request\n- [ ] Validate APDU structure\n\n**Files to modify:**\n- `src/cardlink/server/http_handler.py`\n\n### Task 7.4: Implement Response Building\n- [ ] Implement `build_admin_response()` method\n- [ ] Wrap APDU responses in GP Admin format\n- [ ] Build HTTP response with proper headers\n- [ ] Handle keep-alive for session continuity\n\n**Files to modify:**\n- `src/cardlink/server/http_handler.py`\n\n### Task 7.5: Implement handle_request Method\n- [ ] Implement `handle_request(ssl_socket, session)` method\n- [ ] Read HTTP request from socket\n- [ ] Parse and validate request\n- [ ] Route to command processor\n- [ ] Send response back on socket\n\n**Files to modify:**\n- `src/cardlink/server/http_handler.py`\n\n### Task 7.6: Write HTTPHandler Unit Tests\n- [ ] Test request parsing with valid GP Admin request\n- [ ] Test content-type validation (accept and reject)\n- [ ] Test APDU extraction from request body\n- [ ] Test response building\n- [ ] Test HTTP keep-alive handling\n\n**Files to create:**\n- `tests/unit/test_http_handler.py`\n\n---\n\n## Task 8: GP Command Processor Implementation\n\n### Task 8.1: Implement GPCommandProcessor Core\n- [ ] Create `gp_command_processor.py` with GPCommandProcessor class\n- [ ] Initialize with response handlers dict and EventEmitter\n- [ ] Implement `register_handler()` method\n- [ ] Implement `process_command()` routing method\n\n**Files to create:**\n- `src/cardlink/server/gp_command_processor.py`\n\n### Task 8.2: Implement Command Handlers\n- [ ] Implement SelectHandler (INS 0xA4)\n- [ ] Implement InstallHandler (INS 0xE6)\n- [ ] Implement DeleteHandler (INS 0xE4)\n- [ ] Implement GetStatusHandler (INS 0xF2)\n- [ ] Implement InitUpdateHandler (INS 0x50)\n- [ ] Implement ExtAuthHandler (INS 0x82)\n- [ ] Return SW 6D00 for unknown INS codes\n\n**Files to modify:**\n- `src/cardlink/server/gp_command_processor.py`\n\n### Task 8.3: Implement Command Logging\n- [ ] Log command bytes on receipt\n- [ ] Log response bytes on send\n- [ ] Log status word\n- [ ] Log timing (duration in ms)\n- [ ] Emit `apdu_received` and `apdu_sent` events\n\n**Files to modify:**\n- `src/cardlink/server/gp_command_processor.py`\n\n### Task 8.4: Write GPCommandProcessor Unit Tests\n- [ ] Test command routing to correct handler\n- [ ] Test unknown command handling (SW 6D00)\n- [ ] Test event emission for APDU exchanges\n- [ ] Test timing measurement\n- [ ] Test each handler with sample commands\n\n**Files to create:**\n- `tests/unit/test_gp_command_processor.py`\n\n---\n\n## Task 9: Admin Server Implementation\n\n### Task 9.1: Implement AdminServer Core\n- [ ] Create `admin_server.py` with AdminServer class\n- [ ] Initialize with ServerConfig, KeyStore, EventEmitter, optional MetricsCollector\n- [ ] Create TLSHandler, HTTPHandler, SessionManager, ErrorHandler instances\n- [ ] Implement `is_running` property\n\n**Files to create:**\n- `src/cardlink/server/admin_server.py`\n\n### Task 9.2: Implement Server Start\n- [ ] Implement `start()` method\n- [ ] Create server socket and bind to configured port\n- [ ] Set socket options (SO_REUSEADDR)\n- [ ] Start listening for connections\n- [ ] Create ThreadPoolExecutor for connection handling\n- [ ] Emit `server_started` event\n- [ ] Log listening address and port\n\n**Files to modify:**\n- `src/cardlink/server/admin_server.py`\n\n### Task 9.3: Implement Connection Acceptance Loop\n- [ ] Accept connections in main thread\n- [ ] Submit connection handling to thread pool\n- [ ] Handle accept errors gracefully\n- [ ] Check for shutdown signal\n\n**Files to modify:**\n- `src/cardlink/server/admin_server.py`\n\n### Task 9.4: Implement Connection Handler\n- [ ] Implement `_handle_connection()` method\n- [ ] Wrap socket with TLS via TLSHandler\n- [ ] Create session via SessionManager\n- [ ] Loop handling HTTP requests via HTTPHandler\n- [ ] Handle connection errors via ErrorHandler\n- [ ] Close session on disconnect\n\n**Files to modify:**\n- `src/cardlink/server/admin_server.py`\n\n### Task 9.5: Implement Server Stop\n- [ ] Implement `stop(timeout)` method\n- [ ] Signal shutdown to accept loop\n- [ ] Close all active sessions gracefully\n- [ ] Shutdown ThreadPoolExecutor\n- [ ] Close server socket\n- [ ] Emit `server_stopped` event\n- [ ] Ensure cleanup completes within timeout\n\n**Files to modify:**\n- `src/cardlink/server/admin_server.py`\n\n### Task 9.6: Implement get_active_sessions\n- [ ] Implement `get_active_sessions()` method\n- [ ] Return list of active Session objects\n- [ ] Thread-safe access to session manager\n\n**Files to modify:**\n- `src/cardlink/server/admin_server.py`\n\n### Task 9.7: Write AdminServer Unit Tests\n- [ ] Test server start and stop\n- [ ] Test connection acceptance\n- [ ] Test graceful shutdown with active sessions\n- [ ] Test max connections limit\n\n**Files to create:**\n- `tests/unit/test_admin_server.py`\n\n---\n\n## Task 10: CLI Integration\n\n### Task 10.1: Implement cardlink-server CLI\n- [ ] Create/update `src/cardlink/cli/server.py`\n- [ ] Implement `start` command with Click\n- [ ] Add `--port` option (default 8443)\n- [ ] Add `--config` option for YAML config file\n- [ ] Add `--dashboard` flag to enable web dashboard\n- [ ] Add `--ciphers` option for cipher suite selection\n- [ ] Add `--enable-null-ciphers` flag with warning\n\n**Files to create/modify:**\n- `src/cardlink/cli/server.py`\n\n### Task 10.2: Implement stop Command\n- [ ] Implement `stop` command\n- [ ] Send shutdown signal to running server\n- [ ] Wait for graceful shutdown\n- [ ] Report shutdown status\n\n**Files to modify:**\n- `src/cardlink/cli/server.py`\n\n### Task 10.3: Implement Configuration Loading\n- [ ] Load configuration from YAML file\n- [ ] Support environment variable overrides\n- [ ] Validate configuration on load\n- [ ] Fail fast with clear error message on invalid config\n\n**Files to modify:**\n- `src/cardlink/cli/server.py`\n\n### Task 10.4: Write CLI Integration Tests\n- [ ] Test `cardlink-server start` command\n- [ ] Test `cardlink-server start --port 9443`\n- [ ] Test `cardlink-server stop` command\n- [ ] Test configuration file loading\n- [ ] Test invalid configuration handling\n\n**Files to create:**\n- `tests/integration/test_server_cli.py`\n\n---\n\n## Task 11: Integration Testing\n\n### Task 11.1: Write PSK Handshake Integration Tests\n- [ ] Test full PSK-TLS handshake with valid key\n- [ ] Test handshake failure with wrong key\n- [ ] Test handshake with each supported cipher suite\n- [ ] Test NULL cipher handshake (when enabled)\n\n**Files to create:**\n- `tests/integration/test_psk_handshake.py`\n\n### Task 11.2: Write Session Integration Tests\n- [ ] Test session creation on connection\n- [ ] Test session timeout expiration\n- [ ] Test session state transitions during operation\n- [ ] Test concurrent sessions\n\n**Files to create:**\n- `tests/integration/test_sessions.py`\n\n### Task 11.3: Write Error Handling Integration Tests\n- [ ] Test connection interruption mid-session\n- [ ] Test PSK mismatch detection and alerting\n- [ ] Test handshake timeout handling\n- [ ] Test error rate threshold alerting\n\n**Files to create:**\n- `tests/integration/test_error_handling.py`\n\n### Task 11.4: Write GP Protocol Integration Tests\n- [ ] Test SELECT command processing\n- [ ] Test INSTALL command processing\n- [ ] Test DELETE command processing\n- [ ] Test GET STATUS command processing\n- [ ] Test full GP Admin HTTP exchange\n\n**Files to create:**\n- `tests/integration/test_gp_protocol.py`\n\n---\n\n## Task 12: Documentation and Examples\n\n### Task 12.1: Create Example Configuration Files\n- [ ] Create `examples/configs/server_config.yaml` with all options documented\n- [ ] Create `examples/configs/psk_keys.yaml` with example keys\n- [ ] Add comments explaining each configuration option\n\n**Files to create:**\n- `examples/configs/server_config.yaml`\n- `examples/configs/psk_keys.yaml`\n\n### Task 12.2: Update Module Documentation\n- [ ] Add docstrings to all public classes and methods\n- [ ] Create README in `src/cardlink/server/` explaining module usage\n- [ ] Document event types and data schemas\n\n**Files to create/modify:**\n- `src/cardlink/server/README.md`\n- All server module files (docstrings)\n\n---\n\n## Summary\n\n| Task Group | Tasks | Description |\n|------------|-------|-------------|\n| Task 1 | 1.1 - 1.2 | Project setup and configuration |\n| Task 2 | 2.1 - 2.4 | KeyStore implementation |\n| Task 3 | 3.1 - 3.3 | EventEmitter implementation |\n| Task 4 | 4.1 - 4.7 | TLSHandler implementation |\n| Task 5 | 5.1 - 5.5 | SessionManager implementation |\n| Task 6 | 6.1 - 6.6 | ErrorHandler implementation |\n| Task 7 | 7.1 - 7.6 | HTTPHandler implementation |\n| Task 8 | 8.1 - 8.4 | GPCommandProcessor implementation |\n| Task 9 | 9.1 - 9.7 | AdminServer implementation |\n| Task 10 | 10.1 - 10.4 | CLI integration |\n| Task 11 | 11.1 - 11.4 | Integration testing |\n| Task 12 | 12.1 - 12.2 | Documentation |\n\n**Total: 12 task groups, 47 subtasks**\n",
  "fileStats": {
    "size": 19045,
    "lines": 592,
    "lastModified": "2025-11-25T10:43:30.863Z"
  },
  "comments": []
}