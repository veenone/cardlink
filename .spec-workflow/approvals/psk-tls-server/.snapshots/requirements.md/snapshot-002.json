{
  "id": "snapshot_1764066174234_s2mild4wj",
  "approvalId": "approval_1764065523154_fr6dw2m6a",
  "approvalTitle": "PSK-TLS Server Requirements",
  "version": 2,
  "timestamp": "2025-11-25T10:22:54.234Z",
  "trigger": "revision_requested",
  "status": "pending",
  "content": "# Requirements Document: PSK-TLS Admin Server\n\n## Introduction\n\nThe PSK-TLS Admin Server is the core component of CardLink that implements a GlobalPlatform Amendment B compliant Remote Application Management (RAM) over HTTP server. This server enables secure communication with UICC cards using Pre-Shared Key TLS (PSK-TLS) for authentication, allowing testers to send GP commands to cards via the Bearer Independent Protocol (BIP) initiated HTTPS connections from the UICC.\n\nThis component is foundational to CardLink as it serves as the endpoint that UICC cards connect to during OTA testing, simulating a production OTA server in a controlled local environment.\n\n## Alignment with Product Vision\n\nThis feature directly supports CardLink's core mission of providing accessible SCP81 compliance testing:\n\n- **Eliminates need for production OTA infrastructure**: Provides a fully functional admin server locally\n- **Enables real hardware testing**: Accepts actual UICC-initiated connections\n- **Protocol transparency**: Full logging of TLS handshakes and APDU exchanges\n- **Local-first design**: Runs on developer's machine without cloud dependencies\n- **Modular architecture**: Server component can operate independently or with other CardLink components\n\n## Requirements\n\n### Requirement 1: PSK-TLS Connection Handling\n\n**User Story:** As a UICC developer, I want the server to accept PSK-TLS connections from UICC cards, so that I can test secure OTA communication without requiring certificate-based PKI infrastructure.\n\n#### Acceptance Criteria\n\n1. WHEN a UICC initiates a TLS connection with PSK identity THEN the server SHALL look up the corresponding PSK key from the configured key store\n2. WHEN the PSK identity is found AND the key matches THEN the server SHALL complete the TLS handshake successfully\n3. WHEN the PSK identity is not found THEN the server SHALL reject the connection with appropriate TLS alert\n4. WHEN the TLS handshake completes THEN the server SHALL log the PSK identity, cipher suite, and session parameters\n5. IF the connection uses an unsupported cipher suite THEN the server SHALL reject with handshake_failure alert\n\n### Requirement 2: HTTP Admin Protocol Implementation\n\n**User Story:** As a QA engineer, I want the server to implement the GP Amendment B HTTP Admin protocol, so that I can send standard RAM commands to UICC cards.\n\n#### Acceptance Criteria\n\n1. WHEN receiving an HTTP POST to /admin THEN the server SHALL parse the request as GP Admin protocol\n2. WHEN a valid command packet is received THEN the server SHALL extract and decode the APDU commands\n3. WHEN processing a command THEN the server SHALL wrap responses in proper GP Admin response format\n4. IF the request content-type is not application/vnd.globalplatform.card-content-mgt;version=1.0 THEN the server SHALL respond with 415 Unsupported Media Type\n5. WHEN a session is established THEN the server SHALL maintain session state for the configured timeout period (default 300 seconds)\n\n### Requirement 3: GP Command Processing\n\n**User Story:** As a UICC developer, I want to send standard GlobalPlatform commands through the server, so that I can perform card content management operations.\n\n#### Acceptance Criteria\n\n1. WHEN receiving a SELECT command THEN the server SHALL forward it to the appropriate response handler\n2. WHEN receiving an INSTALL command THEN the server SHALL process installation parameters and return appropriate status\n3. WHEN receiving a DELETE command THEN the server SHALL process deletion parameters and return appropriate status\n4. WHEN receiving a GET STATUS command THEN the server SHALL return card content information\n5. WHEN receiving any GP command THEN the server SHALL log command bytes, response bytes, status word, and timing\n\n### Requirement 4: Session Management\n\n**User Story:** As a tester, I want the server to manage OTA sessions properly, so that I can handle multiple sequential test operations within a single session.\n\n#### Acceptance Criteria\n\n1. WHEN a new TLS connection is established THEN the server SHALL create a unique session identifier\n2. WHEN a session is active THEN the server SHALL track all APDU exchanges within that session\n3. WHEN a session exceeds the configured timeout (default 300s) THEN the server SHALL terminate the session gracefully\n4. WHEN a session is terminated THEN the server SHALL log session summary including duration, command count, and final status\n5. IF the client disconnects unexpectedly THEN the server SHALL clean up session resources within 5 seconds\n\n### Requirement 5: Server Configuration\n\n**User Story:** As an administrator, I want to configure the server parameters, so that I can adapt it to different testing environments.\n\n#### Acceptance Criteria\n\n1. WHEN the server starts THEN it SHALL load configuration from file (YAML) or environment variables\n2. WHEN configuring PSK keys THEN the server SHALL support loading keys from file or database\n3. WHEN configuring ports THEN the server SHALL allow customization of TLS port (default 8443)\n4. WHEN configuring timeouts THEN the server SHALL support socket timeout (default 60s) and session timeout (default 300s)\n5. IF configuration is invalid THEN the server SHALL fail fast with clear error message\n\n### Requirement 6: CLI Integration\n\n**User Story:** As a developer, I want to control the server via command line, so that I can easily start, stop, and configure it for testing.\n\n#### Acceptance Criteria\n\n1. WHEN running `cardlink-server start` THEN the server SHALL start and listen on configured port\n2. WHEN running `cardlink-server start --port 9443` THEN the server SHALL use the specified port\n3. WHEN running `cardlink-server start --dashboard` THEN the server SHALL also start the web dashboard\n4. WHEN running `cardlink-server stop` THEN the server SHALL gracefully shutdown active sessions\n5. WHEN the server starts successfully THEN it SHALL display listening address and port\n\n### Requirement 7: Event Emission for Integration\n\n**User Story:** As a dashboard developer, I want the server to emit events for key activities, so that I can display real-time updates to users.\n\n#### Acceptance Criteria\n\n1. WHEN a TLS handshake begins THEN the server SHALL emit a `tls_handshake_start` event\n2. WHEN a TLS handshake completes THEN the server SHALL emit a `tls_handshake_complete` event with details\n3. WHEN an APDU command is received THEN the server SHALL emit an `apdu_received` event\n4. WHEN an APDU response is sent THEN the server SHALL emit an `apdu_sent` event\n5. WHEN a session ends THEN the server SHALL emit a `session_ended` event with summary\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle**: Separate classes for TLS handling, HTTP protocol, GP command processing, and session management\n- **Modular Design**: Server module should be usable standalone without dashboard or database dependencies\n- **Dependency Management**: Use dependency injection for key store, session store, and event emitter\n- **Clear Interfaces**: Define abstract interfaces for extensibility (e.g., different key store backends)\n\n### Performance\n\n- **Connection handling**: Server SHALL handle at least 10 concurrent TLS connections\n- **Response latency**: Server SHALL respond to APDU commands within 100ms (excluding network latency)\n- **Memory efficiency**: Server SHALL not exceed 100MB memory for typical operation\n- **Startup time**: Server SHALL be ready to accept connections within 3 seconds\n\n### Security\n\n- **TLS version**: Server SHALL support TLS 1.2 with PSK cipher suites (TLS_PSK_WITH_AES_128_CBC_SHA256, TLS_PSK_WITH_AES_256_CBC_SHA384)\n- **Key protection**: PSK keys SHALL NOT be logged in plaintext\n- **Session isolation**: Each session SHALL be isolated; one session cannot access another's data\n- **Input validation**: All incoming data SHALL be validated before processing\n\n### Reliability\n\n- **Graceful degradation**: Server SHALL continue operating if non-critical components fail\n- **Error recovery**: Server SHALL recover from transient errors without restart\n- **Resource cleanup**: Server SHALL properly release all resources on shutdown\n- **Logging**: All errors SHALL be logged with sufficient context for debugging\n\n### Usability\n\n- **Clear logging**: Server logs SHALL include timestamps, log levels, and structured data\n- **Helpful errors**: Error messages SHALL indicate cause and potential resolution\n- **Status visibility**: Server SHALL provide health check endpoint for monitoring\n- **Documentation**: All configuration options SHALL be documented with examples\n",
  "fileStats": {
    "size": 8617,
    "lines": 141,
    "lastModified": "2025-11-25T10:11:23.443Z"
  },
  "comments": []
}