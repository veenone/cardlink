{
  "id": "snapshot_1764068707025_vq0bnzgd4",
  "approvalId": "approval_1764068695031_wsud5ij2m",
  "approvalTitle": "Phone Controller Requirements (Revised)",
  "version": 3,
  "timestamp": "2025-11-25T11:05:07.025Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document: Phone Controller\n\n## Introduction\n\nThe Phone Controller is the CardLink component responsible for managing Android smartphones used as test harnesses for SCP81 OTA testing. It provides device control via ADB (Android Debug Bridge), AT command interface for modem access, network configuration, BIP event monitoring, and SMS-PP trigger simulation.\n\nThis component enables testers to use real Android phones to initiate UICC-to-server connections, monitoring the complete OTA flow from SMS trigger through BIP channel establishment to HTTPS communication.\n\n## Alignment with Product Vision\n\nThis feature directly supports CardLink's core mission of providing accessible SCP81 compliance testing:\n\n- **Real hardware testing**: Uses actual Android phones rather than simulators\n- **Local-first design**: USB/ADB connection without network infrastructure\n- **Protocol transparency**: Full visibility into BIP events, AT responses, and logcat\n- **End-to-end validation**: Complete flow from SMS trigger to OTA session\n- **Multi-device support**: Tested on Pixel, Samsung, OnePlus devices\n\n## Requirements\n\n### Requirement 1: ADB Device Discovery and Connection\n\n**User Story:** As a tester, I want the controller to automatically discover connected Android phones, so that I can quickly start testing without manual configuration.\n\n#### Acceptance Criteria\n\n1. WHEN the controller starts THEN it SHALL scan for connected ADB devices\n2. WHEN a device is connected via USB THEN the controller SHALL detect it within 5 seconds\n3. WHEN a device is detected THEN the controller SHALL retrieve device info (model, serial, Android version)\n4. WHEN a device is disconnected THEN the controller SHALL detect disconnection within 5 seconds\n5. WHEN multiple devices are connected THEN the controller SHALL list all devices with identifiers\n6. IF ADB is not installed or not in PATH THEN the controller SHALL display helpful error message\n\n### Requirement 2: Device Information Retrieval and Profiling\n\n**User Story:** As a tester, I want to query comprehensive information about connected phones and UICC cards, so that I can create device profiles and verify I'm testing on the correct device/card combination.\n\n#### Acceptance Criteria\n\n##### Device Information\n1. WHEN querying device info THEN the controller SHALL return:\n   - Device model name\n   - Manufacturer\n   - Android version and API level\n   - Build number\n   - Serial number\n   - IMEI (International Mobile Equipment Identity)\n   - Baseband/modem firmware version\n   - Kernel version\n\n##### UICC/SIM Information\n2. WHEN querying UICC info THEN the controller SHALL return:\n   - SIM/UICC status (present/absent/locked/ready)\n   - ICCID (Integrated Circuit Card Identifier)\n   - IMSI (International Mobile Subscriber Identity)\n   - MSISDN (phone number, if available)\n   - SPN (Service Provider Name)\n   - MCC/MNC (Mobile Country Code / Mobile Network Code)\n   - SIM slot information (for dual-SIM devices)\n\n##### Network Information\n3. WHEN querying network info THEN the controller SHALL return:\n   - Current network operator name\n   - Network type (LTE, 5G, etc.)\n   - Signal strength\n   - Data connection state\n   - APN configuration\n\n##### Profiling Features\n4. WHEN creating a device profile THEN the controller SHALL store all queryable information as a snapshot\n5. WHEN comparing profiles THEN the controller SHALL highlight differences between current state and saved profile\n6. WHEN the UICC is changed THEN the controller SHALL detect the change within 10 seconds\n7. WHEN device info is requested THEN the controller SHALL support both cached retrieval and forced refresh\n8. WHEN exporting profile THEN the controller SHALL support JSON format for external tools\n\n### Requirement 3: AT Command Interface\n\n**User Story:** As a UICC developer, I want to send AT commands to the phone's modem, so that I can interact with the UICC and monitor modem status.\n\n#### Acceptance Criteria\n\n1. WHEN sending an AT command THEN the controller SHALL route it through the appropriate modem interface\n2. WHEN receiving an AT response THEN the controller SHALL parse and return the result\n3. WHEN sending AT commands THEN the controller SHALL support common commands:\n   - AT+CPIN? (SIM status)\n   - AT+CIMI (IMSI)\n   - AT+CCID (ICCID)\n   - AT+CGDCONT (PDP context)\n   - AT+CSIM (generic SIM access)\n4. WHEN AT access requires root THEN the controller SHALL detect and report the requirement\n5. WHEN AT interface is unavailable THEN the controller SHALL provide alternative methods or clear error\n\n### Requirement 4: Network Configuration\n\n**User Story:** As a tester, I want to configure the phone's network settings, so that I can direct OTA traffic to my local test server.\n\n#### Acceptance Criteria\n\n1. WHEN configuring network THEN the controller SHALL support WiFi enable/disable\n2. WHEN configuring network THEN the controller SHALL support WiFi network connection by SSID\n3. WHEN configuring network THEN the controller SHALL support mobile data enable/disable\n4. WHEN configuring APN THEN the controller SHALL support custom APN settings\n5. WHEN routing traffic THEN the controller SHALL support proxy configuration for HTTP traffic\n6. WHEN verifying connectivity THEN the controller SHALL test connection to admin server URL\n\n### Requirement 5: BIP Event Monitoring\n\n**User Story:** As a UICC developer, I want to monitor Bearer Independent Protocol events, so that I can debug UICC-initiated data connections.\n\n#### Acceptance Criteria\n\n1. WHEN BIP events occur THEN the controller SHALL capture them via logcat monitoring\n2. WHEN a BIP OPEN CHANNEL event is detected THEN the controller SHALL log channel parameters\n3. WHEN a BIP SEND DATA event is detected THEN the controller SHALL log data details\n4. WHEN a BIP RECEIVE DATA event is detected THEN the controller SHALL log response details\n5. WHEN a BIP CLOSE CHANNEL event is detected THEN the controller SHALL log closure reason\n6. WHEN monitoring BIP THEN the controller SHALL emit events for dashboard integration\n7. WHEN BIP events are captured THEN the controller SHALL correlate with OTA sessions\n\n### Requirement 6: SMS-PP Trigger Simulation\n\n**User Story:** As a tester, I want to send SMS-PP trigger messages to the UICC, so that I can initiate OTA sessions without a real mobile network.\n\n#### Acceptance Criteria\n\n1. WHEN sending SMS-PP THEN the controller SHALL encode the message as proper PDU format\n2. WHEN sending SMS-PP THEN the controller SHALL support OTA trigger formats (GP Amendment B)\n3. WHEN sending SMS-PP THEN the controller SHALL route via AT+CMGS or equivalent method\n4. WHEN SMS-PP is sent THEN the controller SHALL log the PDU bytes and delivery status\n5. IF direct SMS injection is not possible THEN the controller SHALL provide alternative trigger methods\n6. WHEN configuring triggers THEN the controller SHALL support custom PDU templates\n\n### Requirement 7: Logcat Monitoring and Parsing\n\n**User Story:** As a developer, I want to monitor Android logcat for relevant events, so that I can debug issues in the OTA flow.\n\n#### Acceptance Criteria\n\n1. WHEN monitoring logcat THEN the controller SHALL filter for relevant tags (Telephony, SIM, BIP, CAT)\n2. WHEN parsing logcat THEN the controller SHALL extract structured events from log lines\n3. WHEN relevant events occur THEN the controller SHALL emit parsed events\n4. WHEN monitoring THEN the controller SHALL support starting/stopping log capture\n5. WHEN exporting THEN the controller SHALL support saving logcat to file\n6. WHEN monitoring THEN the controller SHALL handle log buffer overflow gracefully\n\n### Requirement 8: CLI Integration\n\n**User Story:** As a developer, I want to control phones via command line, so that I can automate testing workflows.\n\n#### Acceptance Criteria\n\n1. WHEN running `cardlink-phone list` THEN the CLI SHALL display all connected devices with basic info\n2. WHEN running `cardlink-phone info <device>` THEN the CLI SHALL show comprehensive device details:\n   - Use `--device` for device info only\n   - Use `--sim` for UICC/SIM info only\n   - Use `--network` for network info only\n   - Use `--all` (default) for complete profile\n   - Use `--json` for JSON output format\n3. WHEN running `cardlink-phone at <device> <command>` THEN the CLI SHALL send AT command\n4. WHEN running `cardlink-phone trigger <device>` THEN the CLI SHALL send OTA trigger\n5. WHEN running `cardlink-phone monitor <device>` THEN the CLI SHALL start BIP/logcat monitoring\n6. WHEN running `cardlink-phone profile save <name>` THEN the CLI SHALL save current device state as profile\n7. WHEN running `cardlink-phone profile load <name>` THEN the CLI SHALL apply saved profile settings\n8. WHEN running `cardlink-phone profile compare <name>` THEN the CLI SHALL compare current state to saved profile\n9. WHEN running commands THEN the CLI SHALL support `--device` flag for multi-device selection\n\n### Requirement 9: Event Emission for Integration\n\n**User Story:** As a dashboard developer, I want the phone controller to emit events, so that I can display phone status and BIP events in real-time.\n\n#### Acceptance Criteria\n\n1. WHEN a device is connected THEN the controller SHALL emit `device_connected` event\n2. WHEN a device is disconnected THEN the controller SHALL emit `device_disconnected` event\n3. WHEN a BIP event is detected THEN the controller SHALL emit `bip_event` with details\n4. WHEN an SMS trigger is sent THEN the controller SHALL emit `sms_trigger_sent` event\n5. WHEN an error occurs THEN the controller SHALL emit `device_error` event with details\n\n### Requirement 10: Device Profile Management\n\n**User Story:** As a tester, I want to save device configurations, so that I can quickly set up devices for repeated testing.\n\n#### Acceptance Criteria\n\n1. WHEN creating a profile THEN the controller SHALL store device settings (APN, WiFi, trigger config)\n2. WHEN applying a profile THEN the controller SHALL configure the device automatically\n3. WHEN listing profiles THEN the controller SHALL show available configurations\n4. WHEN a profile is applied THEN the controller SHALL verify settings were applied successfully\n5. WHEN storing profiles THEN the controller SHALL persist to database or file\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility**: Separate classes for ADB control, AT interface, BIP monitoring, SMS encoding\n- **Modular Design**: Phone controller usable standalone without server or database\n- **Abstraction Layer**: Abstract device interface to support future iOS extension\n- **Dependency Injection**: Inject ADB path, timeout settings, event emitter\n\n### Performance\n\n- **Device detection**: Detect connected devices within 5 seconds\n- **AT command latency**: Return AT command response within 2 seconds\n- **Logcat processing**: Process logcat lines with < 100ms latency\n- **Memory efficiency**: Handle continuous logcat monitoring without memory leaks\n\n### Compatibility\n\n- **Android versions**: Support Android 8.0 (API 26) and higher\n- **Tested devices**: Validated on Google Pixel, Samsung Galaxy, OnePlus\n- **ADB versions**: Support ADB version 1.0.41 and higher\n- **Root requirement**: Document which features require root access\n\n### Reliability\n\n- **Connection recovery**: Automatically reconnect on USB disconnect/reconnect\n- **Error handling**: Graceful handling of device not responding\n- **Timeout management**: Configurable timeouts for all operations\n- **Resource cleanup**: Properly release ADB connections on shutdown\n\n### Security\n\n- **USB debugging**: Require USB debugging enabled (user must authorize)\n- **No credentials stored**: Do not store device unlock PINs or passwords\n- **Logging**: Do not log sensitive AT command data (IMSI, keys) in plaintext\n",
  "fileStats": {
    "size": 11776,
    "lines": 226,
    "lastModified": "2025-11-25T11:04:48.596Z"
  },
  "comments": []
}