{
  "id": "snapshot_1764069225422_3wt63glzj",
  "approvalId": "approval_1764069225410_7b7zmlalq",
  "approvalTitle": "Phone Controller Tasks Document",
  "version": 1,
  "timestamp": "2025-11-25T11:13:45.422Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Implementation Tasks: Phone Controller\n\n## Task 1: Project Setup and Core Infrastructure\n\n### Task 1.1: Create Phone Module Structure\n- [ ] Create `src/cardlink/phone/` directory structure\n- [ ] Create `__init__.py` with public API exports\n- [ ] Create `models.py` with data models (DeviceProfile, SIMProfile, NetworkProfile, etc.)\n- [ ] Create `exceptions.py` with custom exceptions\n\n**Files to create:**\n- `src/cardlink/phone/__init__.py`\n- `src/cardlink/phone/models.py`\n- `src/cardlink/phone/exceptions.py`\n\n### Task 1.2: Define Data Models\n- [ ] Implement DeviceProfile dataclass\n- [ ] Implement SIMProfile dataclass\n- [ ] Implement NetworkProfile dataclass\n- [ ] Implement FullProfile dataclass\n- [ ] Implement BIPEvent dataclass\n- [ ] Implement ATResponse dataclass\n- [ ] Implement DeviceState enum\n- [ ] Implement BIPEventType enum\n\n**Files to modify:**\n- `src/cardlink/phone/models.py`\n\n### Task 1.3: Define Custom Exceptions\n- [ ] Implement PhoneControllerError base exception\n- [ ] Implement ADBNotFoundError\n- [ ] Implement DeviceNotFoundError\n- [ ] Implement DeviceUnauthorizedError\n- [ ] Implement ATCommandError\n- [ ] Implement RootRequiredError\n- [ ] Implement TimeoutError\n\n**Files to modify:**\n- `src/cardlink/phone/exceptions.py`\n\n---\n\n## Task 2: ADB Client Implementation\n\n### Task 2.1: Implement ADBClient Core\n- [ ] Create `adb_client.py` with ADBClient class\n- [ ] Implement constructor with ADB path configuration\n- [ ] Implement `is_available()` to check ADB in PATH\n- [ ] Store ADB executable path\n\n**Files to create:**\n- `src/cardlink/phone/adb_client.py`\n\n### Task 2.2: Implement Command Execution\n- [ ] Implement `execute(command, serial, timeout)` method\n- [ ] Use asyncio.subprocess for non-blocking execution\n- [ ] Handle command timeouts\n- [ ] Return ADBResult with stdout, stderr, return_code\n- [ ] Add serial-specific command prefix (-s serial)\n\n**Files to modify:**\n- `src/cardlink/phone/adb_client.py`\n\n### Task 2.3: Implement Shell Command\n- [ ] Implement `shell(command, serial, timeout)` method\n- [ ] Wrap command in `adb shell`\n- [ ] Handle shell-specific escaping\n- [ ] Return stdout as string\n\n**Files to modify:**\n- `src/cardlink/phone/adb_client.py`\n\n### Task 2.4: Implement Device Listing\n- [ ] Implement `get_devices()` method\n- [ ] Parse `adb devices -l` output\n- [ ] Extract serial, state, and device info\n- [ ] Return list of device dictionaries\n\n**Files to modify:**\n- `src/cardlink/phone/adb_client.py`\n\n### Task 2.5: Implement Logcat Streaming\n- [ ] Implement `start_logcat(serial, filters)` async generator\n- [ ] Start logcat process with filters\n- [ ] Yield lines as they arrive\n- [ ] Handle process termination\n\n**Files to modify:**\n- `src/cardlink/phone/adb_client.py`\n\n### Task 2.6: Write ADBClient Unit Tests\n- [ ] Test ADB availability check\n- [ ] Test command execution with mock subprocess\n- [ ] Test device list parsing\n- [ ] Test timeout handling\n\n**Files to create:**\n- `tests/unit/phone/test_adb_client.py`\n\n---\n\n## Task 3: Device Manager Implementation\n\n### Task 3.1: Implement DeviceManager Core\n- [ ] Create `device_manager.py` with DeviceManager class\n- [ ] Initialize with ADBClient and EventEmitter\n- [ ] Store connected device registry\n- [ ] Configure polling interval (default 5s)\n\n**Files to create:**\n- `src/cardlink/phone/device_manager.py`\n\n### Task 3.2: Implement Device Scanning\n- [ ] Implement `scan_devices()` method\n- [ ] Call ADBClient.get_devices()\n- [ ] Create DeviceInfo for each device\n- [ ] Return list of DeviceInfo\n\n**Files to modify:**\n- `src/cardlink/phone/device_manager.py`\n\n### Task 3.3: Implement Background Monitoring\n- [ ] Implement `start_monitoring()` async method\n- [ ] Create background task for polling\n- [ ] Compare device list to detect changes\n- [ ] Emit device_connected/disconnected events\n\n**Files to modify:**\n- `src/cardlink/phone/device_manager.py`\n\n### Task 3.4: Implement Stop Monitoring\n- [ ] Implement `stop_monitoring()` method\n- [ ] Cancel background task\n- [ ] Clean up resources\n\n**Files to modify:**\n- `src/cardlink/phone/device_manager.py`\n\n### Task 3.5: Implement Device State Tracking\n- [ ] Track device states (disconnected, unauthorized, offline, connected)\n- [ ] Detect state changes\n- [ ] Emit events on state transitions\n\n**Files to modify:**\n- `src/cardlink/phone/device_manager.py`\n\n### Task 3.6: Write DeviceManager Unit Tests\n- [ ] Test device scanning\n- [ ] Test connection detection\n- [ ] Test disconnection detection\n- [ ] Test state transitions\n\n**Files to create:**\n- `tests/unit/phone/test_device_manager.py`\n\n---\n\n## Task 4: Device Information and Profiling\n\n### Task 4.1: Implement DeviceInfo Core\n- [ ] Create `device_info.py` with DeviceInfo class\n- [ ] Initialize with ADBClient and device serial\n- [ ] Implement caching with TTL\n\n**Files to create:**\n- `src/cardlink/phone/device_info.py`\n\n### Task 4.2: Implement Device Properties Retrieval\n- [ ] Implement `get_device_info()` method\n- [ ] Retrieve model via `getprop ro.product.model`\n- [ ] Retrieve manufacturer via `getprop ro.product.manufacturer`\n- [ ] Retrieve Android version via `getprop ro.build.version.release`\n- [ ] Retrieve API level via `getprop ro.build.version.sdk`\n- [ ] Retrieve serial via `getprop ro.serialno`\n- [ ] Retrieve IMEI via service call or dumpsys\n- [ ] Retrieve baseband version via `getprop gsm.version.baseband`\n- [ ] Build DeviceProfile dataclass\n\n**Files to modify:**\n- `src/cardlink/phone/device_info.py`\n\n### Task 4.3: Implement SIM Information Retrieval\n- [ ] Implement `get_sim_info()` method\n- [ ] Retrieve SIM status via `getprop gsm.sim.state`\n- [ ] Retrieve ICCID via `getprop gsm.sim.iccid` or AT command\n- [ ] Retrieve IMSI via `getprop gsm.sim.imsi` or AT command\n- [ ] Retrieve operator info via `getprop gsm.sim.operator.alpha`\n- [ ] Retrieve MCC/MNC via `getprop gsm.sim.operator.numeric`\n- [ ] Handle dual-SIM devices\n- [ ] Build SIMProfile dataclass\n\n**Files to modify:**\n- `src/cardlink/phone/device_info.py`\n\n### Task 4.4: Implement Network Information Retrieval\n- [ ] Implement `get_network_info()` method\n- [ ] Retrieve operator name\n- [ ] Retrieve network type (LTE, 5G)\n- [ ] Retrieve signal strength via dumpsys\n- [ ] Retrieve data connection state\n- [ ] Retrieve APN configuration\n- [ ] Build NetworkProfile dataclass\n\n**Files to modify:**\n- `src/cardlink/phone/device_info.py`\n\n### Task 4.5: Implement Full Profile\n- [ ] Implement `get_full_profile()` method\n- [ ] Combine device, SIM, and network info\n- [ ] Add timestamp\n- [ ] Build FullProfile dataclass\n\n**Files to modify:**\n- `src/cardlink/phone/device_info.py`\n\n### Task 4.6: Implement Profile Export\n- [ ] Implement `export_json()` method\n- [ ] Serialize FullProfile to JSON\n- [ ] Handle datetime serialization\n\n**Files to modify:**\n- `src/cardlink/phone/device_info.py`\n\n### Task 4.7: Implement Profile Comparison\n- [ ] Implement `compare(profile1, profile2)` static method\n- [ ] Compare each field\n- [ ] Return ProfileDiff with changed fields\n\n**Files to modify:**\n- `src/cardlink/phone/device_info.py`\n\n### Task 4.8: Write DeviceInfo Unit Tests\n- [ ] Test device property retrieval\n- [ ] Test SIM info retrieval\n- [ ] Test network info retrieval\n- [ ] Test JSON export\n- [ ] Test profile comparison\n\n**Files to create:**\n- `tests/unit/phone/test_device_info.py`\n\n---\n\n## Task 5: AT Command Interface\n\n### Task 5.1: Implement ATInterface Core\n- [ ] Create `at_interface.py` with ATInterface class\n- [ ] Initialize with ADBClient and device serial\n- [ ] Detect available AT command methods\n\n**Files to create:**\n- `src/cardlink/phone/at_interface.py`\n\n### Task 5.2: Implement AT Command Methods\n- [ ] Implement service call method\n- [ ] Implement dialer code method\n- [ ] Implement direct device node method (root)\n- [ ] Auto-detect working method on first use\n\n**Files to modify:**\n- `src/cardlink/phone/at_interface.py`\n\n### Task 5.3: Implement send_command\n- [ ] Implement `send_command(command, timeout)` method\n- [ ] Try methods in order until one works\n- [ ] Parse response into ATResponse\n- [ ] Handle OK, ERROR, +CME ERROR responses\n\n**Files to modify:**\n- `src/cardlink/phone/at_interface.py`\n\n### Task 5.4: Implement Common AT Commands\n- [ ] Implement `check_sim_status()` - AT+CPIN?\n- [ ] Implement `get_imsi()` - AT+CIMI\n- [ ] Implement `get_iccid()` - AT+CCID\n- [ ] Implement `send_csim(apdu_hex)` - AT+CSIM\n\n**Files to modify:**\n- `src/cardlink/phone/at_interface.py`\n\n### Task 5.5: Implement Availability Check\n- [ ] Implement `is_available()` method\n- [ ] Implement `requires_root()` method\n- [ ] Cache results\n\n**Files to modify:**\n- `src/cardlink/phone/at_interface.py`\n\n### Task 5.6: Write ATInterface Unit Tests\n- [ ] Test AT command formatting\n- [ ] Test response parsing (OK, ERROR)\n- [ ] Test method fallback logic\n- [ ] Test common commands\n\n**Files to create:**\n- `tests/unit/phone/test_at_interface.py`\n\n---\n\n## Task 6: BIP Monitoring\n\n### Task 6.1: Implement LogcatParser\n- [ ] Create `logcat_parser.py` with LogcatParser class\n- [ ] Define logcat line regex pattern\n- [ ] Define BIP event patterns\n\n**Files to create:**\n- `src/cardlink/phone/logcat_parser.py`\n\n### Task 6.2: Implement Line Parsing\n- [ ] Implement `parse_line(line)` method\n- [ ] Extract timestamp, PID, TID, level, tag, message\n- [ ] Return LogcatEvent or None\n\n**Files to modify:**\n- `src/cardlink/phone/logcat_parser.py`\n\n### Task 6.3: Implement BIP Event Extraction\n- [ ] Implement `is_bip_event(event)` method\n- [ ] Implement `extract_bip_event(event)` method\n- [ ] Match OPEN_CHANNEL pattern\n- [ ] Match CLOSE_CHANNEL pattern\n- [ ] Match SEND_DATA pattern\n- [ ] Match RECEIVE_DATA pattern\n- [ ] Return BIPEvent with details\n\n**Files to modify:**\n- `src/cardlink/phone/logcat_parser.py`\n\n### Task 6.4: Implement BIPMonitor Core\n- [ ] Create `bip_monitor.py` with BIPMonitor class\n- [ ] Initialize with ADBClient, serial, EventEmitter\n- [ ] Store running state\n\n**Files to create:**\n- `src/cardlink/phone/bip_monitor.py`\n\n### Task 6.5: Implement Start/Stop Monitoring\n- [ ] Implement `start()` async method\n- [ ] Start logcat with BIP-related filters\n- [ ] Create background task for log processing\n- [ ] Implement `stop()` method\n- [ ] Cancel background task\n\n**Files to modify:**\n- `src/cardlink/phone/bip_monitor.py`\n\n### Task 6.6: Implement Event Processing\n- [ ] Process logcat lines through LogcatParser\n- [ ] Emit BIP events via EventEmitter\n- [ ] Call registered callbacks\n- [ ] Handle buffer overflow gracefully\n\n**Files to modify:**\n- `src/cardlink/phone/bip_monitor.py`\n\n### Task 6.7: Write BIP Monitoring Unit Tests\n- [ ] Test logcat line parsing\n- [ ] Test BIP event pattern matching\n- [ ] Test OPEN_CHANNEL extraction\n- [ ] Test CLOSE_CHANNEL extraction\n\n**Files to create:**\n- `tests/unit/phone/test_bip_monitor.py`\n\n---\n\n## Task 7: SMS-PP Trigger\n\n### Task 7.1: Implement SMSTrigger Core\n- [ ] Create `sms_trigger.py` with SMSTrigger class\n- [ ] Initialize with ADBClient, serial\n- [ ] Define trigger templates\n\n**Files to create:**\n- `src/cardlink/phone/sms_trigger.py`\n\n### Task 7.2: Implement PDU Encoding\n- [ ] Implement `build_pdu(template, params)` method\n- [ ] Encode SMSC length\n- [ ] Encode PDU type\n- [ ] Encode originating address\n- [ ] Encode PID (0x7F for SIM Data Download)\n- [ ] Encode DCS\n- [ ] Encode user data header\n- [ ] Encode user data (command packet)\n\n**Files to modify:**\n- `src/cardlink/phone/sms_trigger.py`\n\n### Task 7.3: Implement Trigger Templates\n- [ ] Define TriggerTemplate dataclass\n- [ ] Create OTA trigger template\n- [ ] Create RAM command trigger template\n- [ ] Implement `get_templates()` method\n\n**Files to modify:**\n- `src/cardlink/phone/sms_trigger.py`\n\n### Task 7.4: Implement Trigger Sending\n- [ ] Implement `send_trigger(template, params)` method\n- [ ] Try AT+CMGS method first\n- [ ] Try content provider injection (root)\n- [ ] Log PDU bytes\n- [ ] Return TriggerResult with status\n\n**Files to modify:**\n- `src/cardlink/phone/sms_trigger.py`\n\n### Task 7.5: Implement Raw PDU Sending\n- [ ] Implement `send_raw_pdu(pdu)` method\n- [ ] Accept raw bytes\n- [ ] Use same sending methods\n\n**Files to modify:**\n- `src/cardlink/phone/sms_trigger.py`\n\n### Task 7.6: Write SMSTrigger Unit Tests\n- [ ] Test PDU encoding\n- [ ] Test template building\n- [ ] Test hex formatting\n\n**Files to create:**\n- `tests/unit/phone/test_sms_trigger.py`\n\n---\n\n## Task 8: Network Manager\n\n### Task 8.1: Implement NetworkManager Core\n- [ ] Create `network_manager.py` with NetworkManager class\n- [ ] Initialize with ADBClient, serial\n\n**Files to create:**\n- `src/cardlink/phone/network_manager.py`\n\n### Task 8.2: Implement WiFi Control\n- [ ] Implement `enable_wifi()` method using `svc wifi enable`\n- [ ] Implement `disable_wifi()` method using `svc wifi disable`\n- [ ] Return success/failure status\n\n**Files to modify:**\n- `src/cardlink/phone/network_manager.py`\n\n### Task 8.3: Implement WiFi Connection\n- [ ] Implement `connect_wifi(ssid, password)` method\n- [ ] Use `cmd wifi connect-network` on Android 10+\n- [ ] Handle different Android version methods\n- [ ] Verify connection success\n\n**Files to modify:**\n- `src/cardlink/phone/network_manager.py`\n\n### Task 8.4: Implement Mobile Data Control\n- [ ] Implement `enable_mobile_data()` using `svc data enable`\n- [ ] Implement `disable_mobile_data()` using `svc data disable`\n- [ ] Return success/failure status\n\n**Files to modify:**\n- `src/cardlink/phone/network_manager.py`\n\n### Task 8.5: Implement APN Configuration\n- [ ] Implement `set_apn(apn_config)` method\n- [ ] Insert APN via content provider\n- [ ] Handle carrier restrictions\n\n**Files to modify:**\n- `src/cardlink/phone/network_manager.py`\n\n### Task 8.6: Implement Connectivity Test\n- [ ] Implement `test_connectivity(url)` method\n- [ ] Use curl or wget via ADB\n- [ ] Return ConnectivityResult with status and latency\n\n**Files to modify:**\n- `src/cardlink/phone/network_manager.py`\n\n### Task 8.7: Write NetworkManager Unit Tests\n- [ ] Test WiFi enable/disable commands\n- [ ] Test connectivity test parsing\n\n**Files to create:**\n- `tests/unit/phone/test_network_manager.py`\n\n---\n\n## Task 9: Profile Manager\n\n### Task 9.1: Implement ProfileManager Core\n- [ ] Create `profile_manager.py` with ProfileManager class\n- [ ] Initialize with storage path\n- [ ] Create storage directory if not exists\n\n**Files to create:**\n- `src/cardlink/phone/profile_manager.py`\n\n### Task 9.2: Implement Save/Load\n- [ ] Implement `save_profile(name, profile)` method\n- [ ] Serialize to JSON\n- [ ] Write to file\n- [ ] Implement `load_profile(name)` method\n- [ ] Read from file\n- [ ] Deserialize from JSON\n\n**Files to modify:**\n- `src/cardlink/phone/profile_manager.py`\n\n### Task 9.3: Implement List/Delete\n- [ ] Implement `list_profiles()` method\n- [ ] Scan storage directory\n- [ ] Implement `delete_profile(name)` method\n- [ ] Remove profile file\n\n**Files to modify:**\n- `src/cardlink/phone/profile_manager.py`\n\n### Task 9.4: Implement Import/Export\n- [ ] Implement `export_profile(name, format)` method\n- [ ] Return JSON string\n- [ ] Implement `import_profile(name, data)` method\n- [ ] Parse JSON string\n- [ ] Save to storage\n\n**Files to modify:**\n- `src/cardlink/phone/profile_manager.py`\n\n### Task 9.5: Write ProfileManager Unit Tests\n- [ ] Test save/load round-trip\n- [ ] Test list profiles\n- [ ] Test delete profile\n- [ ] Test JSON export/import\n\n**Files to create:**\n- `tests/unit/phone/test_profile_manager.py`\n\n---\n\n## Task 10: Phone Controller Main Class\n\n### Task 10.1: Implement PhoneController Core\n- [ ] Create `controller.py` with PhoneController class\n- [ ] Initialize ADBClient, DeviceManager, EventEmitter\n- [ ] Verify ADB availability on init\n\n**Files to create:**\n- `src/cardlink/phone/controller.py`\n\n### Task 10.2: Implement Device Discovery\n- [ ] Implement `discover_devices()` method\n- [ ] Delegate to DeviceManager\n- [ ] Return list of DeviceInfo\n\n**Files to modify:**\n- `src/cardlink/phone/controller.py`\n\n### Task 10.3: Implement Device Access\n- [ ] Implement `get_device(serial)` method\n- [ ] Return Device instance with all interfaces\n- [ ] Cache Device instances\n\n**Files to modify:**\n- `src/cardlink/phone/controller.py`\n\n### Task 10.4: Implement Event Callbacks\n- [ ] Implement `on_device_connected(callback)` method\n- [ ] Implement `on_device_disconnected(callback)` method\n- [ ] Wire to EventEmitter\n\n**Files to modify:**\n- `src/cardlink/phone/controller.py`\n\n### Task 10.5: Write PhoneController Unit Tests\n- [ ] Test device discovery\n- [ ] Test device access\n- [ ] Test event callbacks\n\n**Files to create:**\n- `tests/unit/phone/test_controller.py`\n\n---\n\n## Task 11: CLI Integration\n\n### Task 11.1: Implement cardlink-phone CLI\n- [ ] Create `src/cardlink/cli/phone.py` with Click commands\n- [ ] Implement `list` command to show connected devices\n- [ ] Display device serial, model, status\n\n**Files to create:**\n- `src/cardlink/cli/phone.py`\n\n### Task 11.2: Implement info Command\n- [ ] Implement `info <device>` command\n- [ ] Add `--device` flag for device info only\n- [ ] Add `--sim` flag for SIM info only\n- [ ] Add `--network` flag for network info only\n- [ ] Add `--all` flag (default) for complete profile\n- [ ] Add `--json` flag for JSON output\n\n**Files to modify:**\n- `src/cardlink/cli/phone.py`\n\n### Task 11.3: Implement at Command\n- [ ] Implement `at <device> <command>` command\n- [ ] Send AT command\n- [ ] Display response\n\n**Files to modify:**\n- `src/cardlink/cli/phone.py`\n\n### Task 11.4: Implement trigger Command\n- [ ] Implement `trigger <device>` command\n- [ ] Add `--template` option for trigger template\n- [ ] Add `--pdu` option for raw PDU\n- [ ] Display result\n\n**Files to modify:**\n- `src/cardlink/cli/phone.py`\n\n### Task 11.5: Implement monitor Command\n- [ ] Implement `monitor <device>` command\n- [ ] Start BIP/logcat monitoring\n- [ ] Display events in real-time\n- [ ] Handle Ctrl+C to stop\n\n**Files to modify:**\n- `src/cardlink/cli/phone.py`\n\n### Task 11.6: Implement profile Commands\n- [ ] Implement `profile save <name>` command\n- [ ] Implement `profile load <name>` command\n- [ ] Implement `profile compare <name>` command\n- [ ] Implement `profile list` command\n\n**Files to modify:**\n- `src/cardlink/cli/phone.py`\n\n### Task 11.7: Write CLI Integration Tests\n- [ ] Test `cardlink-phone list`\n- [ ] Test `cardlink-phone info`\n- [ ] Test `cardlink-phone profile` commands\n\n**Files to create:**\n- `tests/integration/test_phone_cli.py`\n\n---\n\n## Task 12: Integration Testing\n\n### Task 12.1: Write Device Integration Tests\n- [ ] Test device discovery with real device\n- [ ] Test device info retrieval\n- [ ] Test SIM info retrieval\n- [ ] Test network info retrieval\n\n**Files to create:**\n- `tests/integration/test_phone_device.py`\n\n### Task 12.2: Write AT Command Integration Tests\n- [ ] Test AT+CPIN? command\n- [ ] Test AT+CIMI command (if accessible)\n- [ ] Test AT interface detection\n\n**Files to create:**\n- `tests/integration/test_phone_at.py`\n\n### Task 12.3: Write BIP Monitoring Integration Tests\n- [ ] Test logcat streaming\n- [ ] Test BIP event detection (with mock trigger)\n\n**Files to create:**\n- `tests/integration/test_phone_bip.py`\n\n---\n\n## Summary\n\n| Task Group | Tasks | Description |\n|------------|-------|-------------|\n| Task 1 | 1.1 - 1.3 | Project setup and core infrastructure |\n| Task 2 | 2.1 - 2.6 | ADB client implementation |\n| Task 3 | 3.1 - 3.6 | Device manager implementation |\n| Task 4 | 4.1 - 4.8 | Device information and profiling |\n| Task 5 | 5.1 - 5.6 | AT command interface |\n| Task 6 | 6.1 - 6.7 | BIP monitoring |\n| Task 7 | 7.1 - 7.6 | SMS-PP trigger |\n| Task 8 | 8.1 - 8.7 | Network manager |\n| Task 9 | 9.1 - 9.5 | Profile manager |\n| Task 10 | 10.1 - 10.5 | Phone controller main class |\n| Task 11 | 11.1 - 11.7 | CLI integration |\n| Task 12 | 12.1 - 12.3 | Integration testing |\n\n**Total: 12 task groups, 62 subtasks**\n",
  "fileStats": {
    "size": 19740,
    "lines": 694,
    "lastModified": "2025-11-25T11:13:39.785Z"
  },
  "comments": []
}