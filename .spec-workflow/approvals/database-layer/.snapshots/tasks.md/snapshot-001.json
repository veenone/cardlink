{
  "id": "snapshot_1764071726960_cf53wnri6",
  "approvalId": "approval_1764071726946_hauquzxxg",
  "approvalTitle": "Database Layer Tasks Document",
  "version": 1,
  "timestamp": "2025-11-25T11:55:26.960Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document: Database Layer\n\n## Task Overview\n\nThis document breaks down the Database Layer implementation into actionable development tasks organized by component and functionality.\n\n## Tasks\n\n### 1. Project Setup and Dependencies\n\n- [ ] 1.1. Create `cardlink/database/` package structure\n- [ ] 1.2. Add SQLAlchemy 2.0+ dependency to pyproject.toml\n- [ ] 1.3. Add Alembic dependency for migrations\n- [ ] 1.4. Add cryptography dependency for PSK encryption\n- [ ] 1.5. Add pyyaml dependency for YAML export/import\n- [ ] 1.6. Add optional database driver dependencies (mysqlclient, psycopg2-binary)\n- [ ] 1.7. Create pytest fixtures for database testing (in-memory SQLite)\n\n### 2. Database Configuration\n\n- [ ] 2.1. Create `config.py` with DatabaseConfig class\n- [ ] 2.2. Implement DATABASE_URL environment variable parsing\n- [ ] 2.3. Implement default SQLite path (`data/cardlink.db`)\n- [ ] 2.4. Add `is_sqlite`, `is_mysql`, `is_postgresql` properties\n- [ ] 2.5. Add pool configuration options (pool_size, max_overflow, timeout)\n- [ ] 2.6. Add echo option for SQL logging\n- [ ] 2.7. Write unit tests for configuration parsing\n\n### 3. Database Manager Implementation\n\n- [ ] 3.1. Create `manager.py` with DatabaseManager class\n- [ ] 3.2. Implement `initialize()` with engine creation\n- [ ] 3.3. Implement pool configuration per backend (NullPool for SQLite, QueuePool for others)\n- [ ] 3.4. Implement `_ensure_sqlite_directory()` for path creation\n- [ ] 3.5. Implement `_configure_sqlite()` with WAL mode and pragmas\n- [ ] 3.6. Implement `_get_safe_url()` for password redaction in logs\n- [ ] 3.7. Implement `create_session()` factory method\n- [ ] 3.8. Implement `session_scope()` context manager with commit/rollback\n- [ ] 3.9. Implement `create_tables()` using metadata.create_all()\n- [ ] 3.10. Implement `drop_tables()` using metadata.drop_all()\n- [ ] 3.11. Implement `close()` for connection disposal\n- [ ] 3.12. Implement `health_check()` with SELECT 1 query\n- [ ] 3.13. Write unit tests for DatabaseManager\n\n### 4. Base Model Definition\n\n- [ ] 4.1. Create `models/__init__.py` with Base declarative_base\n- [ ] 4.2. Create `models/base.py` with TimestampMixin\n- [ ] 4.3. Implement `generate_uuid()` helper function\n- [ ] 4.4. Define common column types and constraints\n\n### 5. Device Model Implementation\n\n- [ ] 5.1. Create `models/device.py` with DeviceType enum\n- [ ] 5.2. Create Device model with all columns\n- [ ] 5.3. Add device identifiers (id, name, imei, imsi, iccid)\n- [ ] 5.4. Add device info (manufacturer, model, firmware_version)\n- [ ] 5.5. Add connection_settings JSON column\n- [ ] 5.6. Add status fields (last_seen, is_active)\n- [ ] 5.7. Add notes Text column\n- [ ] 5.8. Define indexes (device_type, iccid, last_seen)\n- [ ] 5.9. Define relationships to sessions and test_results\n- [ ] 5.10. Write unit tests for Device model\n\n### 6. Card Profile Model Implementation\n\n- [ ] 6.1. Create `models/card_profile.py` with CardProfile model\n- [ ] 6.2. Add ICCID primary key and IMSI\n- [ ] 6.3. Add card_type and atr columns\n- [ ] 6.4. Add psk_identity and psk_key_encrypted columns\n- [ ] 6.5. Add admin_url column with 255 char limit\n- [ ] 6.6. Add trigger_config JSON column\n- [ ] 6.7. Add bip_config JSON column\n- [ ] 6.8. Add security_domains JSON column\n- [ ] 6.9. Define indexes (card_type, psk_identity)\n- [ ] 6.10. Define relationships to sessions and test_results\n- [ ] 6.11. Write unit tests for CardProfile model\n\n### 7. OTA Session Model Implementation\n\n- [ ] 7.1. Create `models/session.py` with SessionStatus enum\n- [ ] 7.2. Create OTASession model with UUID primary key\n- [ ] 7.3. Add device_id and card_iccid foreign keys\n- [ ] 7.4. Add session_type and status columns\n- [ ] 7.5. Add timestamp columns (started_at, ended_at, duration_ms)\n- [ ] 7.6. Add TLS info columns (cipher_suite, psk_identity)\n- [ ] 7.7. Add error columns (error_code, error_message)\n- [ ] 7.8. Define indexes (device_id, card_iccid, status, created_at)\n- [ ] 7.9. Define relationships (device, card, comm_logs)\n- [ ] 7.10. Write unit tests for OTASession model\n\n### 8. Communication Log Model Implementation\n\n- [ ] 8.1. Create `models/comm_log.py` with CommLog model\n- [ ] 8.2. Add auto-increment primary key\n- [ ] 8.3. Add session_id foreign key\n- [ ] 8.4. Add timestamp column with millisecond precision\n- [ ] 8.5. Add direction column (command/response)\n- [ ] 8.6. Add raw_data Text column\n- [ ] 8.7. Add decoded_data Text column (optional)\n- [ ] 8.8. Add status_word and status_message columns\n- [ ] 8.9. Add latency_ms Float column\n- [ ] 8.10. Define indexes (session_id, timestamp, direction)\n- [ ] 8.11. Write unit tests for CommLog model\n\n### 9. Test Result Model Implementation\n\n- [ ] 9.1. Create `models/test_result.py` with TestStatus enum\n- [ ] 9.2. Create TestResult model with UUID primary key\n- [ ] 9.3. Add run_id for grouping test runs\n- [ ] 9.4. Add suite_name and test_name columns\n- [ ] 9.5. Add device_id and card_iccid foreign keys\n- [ ] 9.6. Add timestamp columns (started_at, ended_at, duration_ms)\n- [ ] 9.7. Add status enum column\n- [ ] 9.8. Add error_message Text column\n- [ ] 9.9. Add assertions and metadata JSON columns\n- [ ] 9.10. Define indexes (run_id, suite_name, status, created_at)\n- [ ] 9.11. Write unit tests for TestResult model\n\n### 10. Setting Model Implementation\n\n- [ ] 10.1. Create `models/setting.py` with Setting model\n- [ ] 10.2. Add key primary key column\n- [ ] 10.3. Add value JSON column\n- [ ] 10.4. Add description and category columns\n- [ ] 10.5. Define index on category\n- [ ] 10.6. Write unit tests for Setting model\n\n### 11. Unit of Work Implementation\n\n- [ ] 11.1. Create `unit_of_work.py` with UnitOfWork class\n- [ ] 11.2. Implement `__enter__` to create session\n- [ ] 11.3. Implement `__exit__` with rollback on exception\n- [ ] 11.4. Implement `commit()` method\n- [ ] 11.5. Implement `rollback()` method\n- [ ] 11.6. Implement `close()` method\n- [ ] 11.7. Implement `_get_repository()` factory method\n- [ ] 11.8. Add repository properties (devices, cards, sessions, logs, tests, settings)\n- [ ] 11.9. Write unit tests for UnitOfWork\n\n### 12. Base Repository Implementation\n\n- [ ] 12.1. Create `repositories/base.py` with Page dataclass\n- [ ] 12.2. Create BaseRepository generic class\n- [ ] 12.3. Implement `get_by_id(id)` method\n- [ ] 12.4. Implement `get_all(limit)` method\n- [ ] 12.5. Implement `find_by(**kwargs)` method\n- [ ] 12.6. Implement `find_one_by(**kwargs)` method\n- [ ] 12.7. Implement `create(entity)` method\n- [ ] 12.8. Implement `create_all(entities)` for bulk insert\n- [ ] 12.9. Implement `update(entity)` method\n- [ ] 12.10. Implement `delete(entity)` method\n- [ ] 12.11. Implement `delete_by_id(id)` method\n- [ ] 12.12. Implement `exists(id)` method\n- [ ] 12.13. Implement `count()` method\n- [ ] 12.14. Implement `count_by(**kwargs)` method\n- [ ] 12.15. Implement `paginate(page, per_page, order_by, descending)` method\n- [ ] 12.16. Write unit tests for BaseRepository\n\n### 13. Device Repository Implementation\n\n- [ ] 13.1. Create `repositories/device.py` with DeviceRepository class\n- [ ] 13.2. Implement `find_by_type(device_type)` method\n- [ ] 13.3. Implement `find_phones()` method\n- [ ] 13.4. Implement `find_modems()` method\n- [ ] 13.5. Implement `find_active()` method\n- [ ] 13.6. Implement `find_recent(hours)` method\n- [ ] 13.7. Implement `search(query)` with ILIKE pattern matching\n- [ ] 13.8. Implement `update_last_seen(device_id)` method\n- [ ] 13.9. Implement `find_by_iccid(iccid)` method\n- [ ] 13.10. Implement `deactivate(device_id)` method\n- [ ] 13.11. Write unit tests for DeviceRepository\n\n### 14. Card Repository Implementation\n\n- [ ] 14.1. Create `repositories/card.py` with CardRepository class\n- [ ] 14.2. Implement `_get_encryption_key()` from environment\n- [ ] 14.3. Initialize Fernet cipher for encryption\n- [ ] 14.4. Implement `create_with_psk(profile, psk_key)` with encryption\n- [ ] 14.5. Implement `get_psk_key(iccid)` with decryption\n- [ ] 14.6. Implement `update_psk(iccid, identity, key)` method\n- [ ] 14.7. Implement `find_by_type(card_type)` method\n- [ ] 14.8. Implement `find_with_psk()` method\n- [ ] 14.9. Implement `find_by_admin_url(url)` method\n- [ ] 14.10. Implement `export_profile(iccid, include_key)` method\n- [ ] 14.11. Write unit tests for CardRepository with encryption\n\n### 15. Session Repository Implementation\n\n- [ ] 15.1. Create `repositories/session.py` with SessionRepository class\n- [ ] 15.2. Implement `create_session(device_id, card_iccid, type)` method\n- [ ] 15.3. Implement `start_session(session_id)` with timestamp\n- [ ] 15.4. Implement `complete_session(session_id)` with duration calculation\n- [ ] 15.5. Implement `fail_session(session_id, error_code, message)` method\n- [ ] 15.6. Implement `set_tls_info(session_id, cipher, psk_identity)` method\n- [ ] 15.7. Implement `find_by_device(device_id, limit)` method\n- [ ] 15.8. Implement `find_by_card(iccid, limit)` method\n- [ ] 15.9. Implement `find_by_status(status)` method\n- [ ] 15.10. Implement `find_active()` method\n- [ ] 15.11. Implement `find_by_date_range(start, end)` method\n- [ ] 15.12. Implement `get_statistics(days)` with aggregations\n- [ ] 15.13. Write unit tests for SessionRepository\n\n### 16. Log Repository Implementation\n\n- [ ] 16.1. Create `repositories/log.py` with LogRepository class\n- [ ] 16.2. Implement batch buffer with configurable size\n- [ ] 16.3. Implement `add_log(session_id, direction, raw_data, ...)` method\n- [ ] 16.4. Implement `add_log_batch(...)` for high-throughput logging\n- [ ] 16.5. Implement `flush_batch()` using bulk_save_objects\n- [ ] 16.6. Implement `find_by_session(session_id)` method\n- [ ] 16.7. Implement `find_by_direction(session_id, direction)` method\n- [ ] 16.8. Implement `find_commands(session_id)` helper\n- [ ] 16.9. Implement `find_responses(session_id)` helper\n- [ ] 16.10. Implement `find_by_status(session_id, status_word)` method\n- [ ] 16.11. Implement `find_errors(session_id)` for non-9000 responses\n- [ ] 16.12. Implement `search_hex(pattern, session_id)` method\n- [ ] 16.13. Implement `purge_old(days)` for retention\n- [ ] 16.14. Implement `count_by_session(session_id)` method\n- [ ] 16.15. Implement `export_session_logs(session_id)` method\n- [ ] 16.16. Write unit tests for LogRepository\n\n### 17. Test Repository Implementation\n\n- [ ] 17.1. Create `repositories/test.py` with TestRepository class\n- [ ] 17.2. Implement `create_result(...)` with all parameters\n- [ ] 17.3. Implement `find_by_run(run_id)` method\n- [ ] 17.4. Implement `find_by_suite(suite_name, limit)` method\n- [ ] 17.5. Implement `find_by_status(status)` method\n- [ ] 17.6. Implement `find_failures(run_id)` method\n- [ ] 17.7. Implement `get_run_summary(run_id)` with statistics\n- [ ] 17.8. Implement `compare_runs(run_id1, run_id2)` for regressions\n- [ ] 17.9. Implement `export_junit_xml(run_id)` method\n- [ ] 17.10. Write unit tests for TestRepository\n\n### 18. Settings Repository Implementation\n\n- [ ] 18.1. Create `repositories/settings.py` with SettingsRepository class\n- [ ] 18.2. Define DEFAULTS dictionary with all default settings\n- [ ] 18.3. Implement `get_value(key, default)` with fallback chain\n- [ ] 18.4. Implement `set_value(key, value, description, category)` method\n- [ ] 18.5. Implement `get_by_category(category)` method\n- [ ] 18.6. Implement `get_all_settings()` merged with defaults\n- [ ] 18.7. Implement `export_yaml()` method\n- [ ] 18.8. Implement `import_yaml(yaml_str)` method\n- [ ] 18.9. Implement `reset_to_defaults(category)` method\n- [ ] 18.10. Write unit tests for SettingsRepository\n\n### 19. Event Emitter Implementation\n\n- [ ] 19.1. Create `events.py` with DatabaseEvent dataclass\n- [ ] 19.2. Create DatabaseEventEmitter class\n- [ ] 19.3. Implement `on(event_type, handler)` registration\n- [ ] 19.4. Implement `off(event_type, handler)` removal\n- [ ] 19.5. Implement `emit(event_type, entity_type, entity_id, data)` method\n- [ ] 19.6. Add wildcard ('*') handler support\n- [ ] 19.7. Add thread-safe handler management with Lock\n- [ ] 19.8. Write unit tests for event emission\n\n### 20. Data Exporter Implementation\n\n- [ ] 20.1. Create `export_import.py` with DataExporter class\n- [ ] 20.2. Implement `export_all(format)` method\n- [ ] 20.3. Implement `export_selective(tables, format)` method\n- [ ] 20.4. Implement `_export_devices()` helper\n- [ ] 20.5. Implement `_export_cards()` helper (without keys by default)\n- [ ] 20.6. Implement `_export_sessions()` helper\n- [ ] 20.7. Implement `_export_settings()` helper\n- [ ] 20.8. Implement `_device_to_dict()` converter\n- [ ] 20.9. Implement `_session_to_dict()` converter\n- [ ] 20.10. Write unit tests for DataExporter\n\n### 21. Data Importer Implementation\n\n- [ ] 21.1. Create DataImporter class in `export_import.py`\n- [ ] 21.2. Implement `import_data(data_str, format, conflict_mode)` method\n- [ ] 21.3. Implement `_import_devices(devices, conflict_mode, results)` helper\n- [ ] 21.4. Implement `_import_cards(cards, conflict_mode, results)` helper\n- [ ] 21.5. Implement `_import_settings(settings, results)` helper\n- [ ] 21.6. Implement `_create_device(data)` helper\n- [ ] 21.7. Implement `_update_device(device, data)` helper\n- [ ] 21.8. Implement `_create_card(data)` helper\n- [ ] 21.9. Implement `_update_card(profile, data)` helper\n- [ ] 21.10. Write unit tests for DataImporter\n\n### 22. Alembic Migration Setup\n\n- [ ] 22.1. Initialize Alembic with `alembic init migrations`\n- [ ] 22.2. Configure `alembic.ini` with DATABASE_URL support\n- [ ] 22.3. Configure `migrations/env.py` with model imports\n- [ ] 22.4. Create initial migration with all tables\n- [ ] 22.5. Document migration workflow in README\n- [ ] 22.6. Write migration helper functions\n\n### 23. Exception Handling\n\n- [ ] 23.1. Create `exceptions.py` with DatabaseError base class\n- [ ] 23.2. Define ConnectionError exception\n- [ ] 23.3. Define MigrationError exception\n- [ ] 23.4. Define IntegrityError exception\n- [ ] 23.5. Define NotFoundError exception\n- [ ] 23.6. Add error handling decorators for repositories\n- [ ] 23.7. Write tests for exception handling\n\n### 24. CLI: Init Command\n\n- [ ] 24.1. Create `cardlink/cli/db.py` with Click group\n- [ ] 24.2. Implement `init` command\n- [ ] 24.3. Add `--force` flag to drop existing tables\n- [ ] 24.4. Display success message with table count\n- [ ] 24.5. Handle connection errors with helpful messages\n- [ ] 24.6. Write CLI tests for init command\n\n### 25. CLI: Migrate Command\n\n- [ ] 25.1. Implement `migrate` command\n- [ ] 25.2. Add `--revision` option for specific revision\n- [ ] 25.3. Add `--dry-run` flag to show SQL without executing\n- [ ] 25.4. Display migration status before and after\n- [ ] 25.5. Handle migration errors with rollback info\n- [ ] 25.6. Write CLI tests for migrate command\n\n### 26. CLI: Status Command\n\n- [ ] 26.1. Implement `status` command\n- [ ] 26.2. Display connection info (backend, URL with password redacted)\n- [ ] 26.3. Display migration status (current revision, pending)\n- [ ] 26.4. Add `--verbose` flag for table details\n- [ ] 26.5. Display table row counts in verbose mode\n- [ ] 26.6. Write CLI tests for status command\n\n### 27. CLI: Export Command\n\n- [ ] 27.1. Implement `export` command\n- [ ] 27.2. Add `--format` option (json, yaml)\n- [ ] 27.3. Add `--tables` option for selective export\n- [ ] 27.4. Add `--output` option for file path\n- [ ] 27.5. Default to stdout if no output file\n- [ ] 27.6. Display export summary (record counts)\n- [ ] 27.7. Write CLI tests for export command\n\n### 28. CLI: Import Command\n\n- [ ] 28.1. Implement `import` command with file argument\n- [ ] 28.2. Add `--format` option (json, yaml, auto-detect)\n- [ ] 28.3. Add `--conflict` option (skip, overwrite, merge)\n- [ ] 28.4. Display import preview before applying\n- [ ] 28.5. Add `--dry-run` flag to preview without changes\n- [ ] 28.6. Display import summary (created, updated, skipped)\n- [ ] 28.7. Write CLI tests for import command\n\n### 29. CLI: Purge Command\n\n- [ ] 29.1. Implement `purge` command\n- [ ] 29.2. Add `--older-than` option with days parameter\n- [ ] 29.3. Add `--tables` option (logs, sessions, tests)\n- [ ] 29.4. Add confirmation prompt before deletion\n- [ ] 29.5. Add `--yes` flag to skip confirmation\n- [ ] 29.6. Display purge summary (deleted counts)\n- [ ] 29.7. Write CLI tests for purge command\n\n### 30. CLI: Stats Command\n\n- [ ] 30.1. Implement `stats` command\n- [ ] 30.2. Display table row counts\n- [ ] 30.3. Display database size (SQLite file size, others estimated)\n- [ ] 30.4. Display recent activity summary\n- [ ] 30.5. Add `--json` flag for machine-readable output\n- [ ] 30.6. Write CLI tests for stats command\n\n### 31. CLI Entry Point\n\n- [ ] 31.1. Register `cardlink-db` entry point in pyproject.toml\n- [ ] 31.2. Add version option to CLI group\n- [ ] 31.3. Add global `--database` option for URL override\n- [ ] 31.4. Add global `--verbose` option for debug logging\n- [ ] 31.5. Write integration tests for complete CLI workflows\n\n### 32. Integration with Other Components\n\n- [ ] 32.1. Add event emission to repository create/update/delete operations\n- [ ] 32.2. Create database initialization helper for server startup\n- [ ] 32.3. Add session logging integration for PSK-TLS server\n- [ ] 32.4. Add device profile integration for phone/modem controllers\n- [ ] 32.5. Add test result integration for test runner\n- [ ] 32.6. Write integration tests with mock components\n\n### 33. Performance Optimization\n\n- [ ] 33.1. Add index creation verification script\n- [ ] 33.2. Implement query performance logging (optional)\n- [ ] 33.3. Add connection pool monitoring\n- [ ] 33.4. Implement log batch size tuning\n- [ ] 33.5. Add query result caching for settings\n- [ ] 33.6. Write performance benchmarks\n\n### 34. Documentation\n\n- [ ] 34.1. Write module docstrings for all classes\n- [ ] 34.2. Document DATABASE_URL format for each backend\n- [ ] 34.3. Document migration workflow\n- [ ] 34.4. Create CLI usage examples\n- [ ] 34.5. Document encryption key setup for PSK storage\n- [ ] 34.6. Add troubleshooting guide for common database errors\n\n## Task Dependencies\n\n```\n1 (Setup)\n├── 2 (Config)\n│   └── 3 (Manager)\n├── 4 (Base Model)\n│   ├── 5 (Device Model)\n│   ├── 6 (Card Model)\n│   ├── 7 (Session Model)\n│   ├── 8 (CommLog Model)\n│   ├── 9 (TestResult Model)\n│   └── 10 (Setting Model)\n├── 11 (UnitOfWork) ← depends on 3, 12\n├── 12 (Base Repository) ← depends on 4\n│   ├── 13 (Device Repository) ← depends on 5\n│   ├── 14 (Card Repository) ← depends on 6\n│   ├── 15 (Session Repository) ← depends on 7\n│   ├── 16 (Log Repository) ← depends on 8\n│   ├── 17 (Test Repository) ← depends on 9\n│   └── 18 (Settings Repository) ← depends on 10\n├── 19 (Event Emitter)\n├── 20-21 (Export/Import) ← depends on 11, 13-18\n├── 22 (Alembic) ← depends on all models\n└── 23 (Exceptions)\n\nCLI Tasks (24-31) ← depend on corresponding components\n32 (Integration) ← depends on all components\n33 (Performance) ← can run after core implementation\n34 (Documentation) ← finalize after implementation\n```\n\n## Estimated Effort\n\n| Task Group | Tasks | Complexity |\n|------------|-------|------------|\n| Setup | 1.1-1.7 | Low |\n| Config | 2.1-2.7 | Low |\n| Manager | 3.1-3.13 | Medium |\n| Models | 4-10 | Medium |\n| Unit of Work | 11.1-11.9 | Low |\n| Base Repository | 12.1-12.16 | Medium |\n| Entity Repositories | 13-18 | Medium |\n| Event Emitter | 19.1-19.8 | Low |\n| Export/Import | 20-21 | Medium |\n| Alembic | 22.1-22.6 | Medium |\n| Exceptions | 23.1-23.7 | Low |\n| CLI Commands | 24-31 | Medium |\n| Integration | 32.1-32.6 | Medium |\n| Performance | 33.1-33.6 | Medium |\n| Documentation | 34.1-34.6 | Low |\n\n## Notes\n\n- SQLite is the default for development and single-user deployments\n- MySQL/PostgreSQL recommended for team environments with concurrent access\n- PSK keys must be encrypted; CARDLINK_ENCRYPTION_KEY environment variable required\n- Alembic migrations should be created for any schema changes\n- Log repository uses batch inserts for high-throughput APDU logging\n- Event emission enables real-time dashboard updates on data changes\n- JUnit XML export enables CI/CD integration for test results\n",
  "fileStats": {
    "size": 20213,
    "lines": 467,
    "lastModified": "2025-11-25T11:55:20.735Z"
  },
  "comments": []
}