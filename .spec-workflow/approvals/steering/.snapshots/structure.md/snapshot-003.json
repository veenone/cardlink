{
  "id": "snapshot_1764064115029_rkfgxy3rh",
  "approvalId": "approval_1764063964144_4arxdb0ai",
  "approvalTitle": "Structure Steering Document (Revised)",
  "version": 3,
  "timestamp": "2025-11-25T09:48:35.029Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Project Structure\n\n## Directory Organization\n\n```\ncardlink/\n├── src/\n│   └── cardlink/\n│       ├── __init__.py\n│       ├── cli/                      # CLI Layer\n│       │   ├── __init__.py\n│       │   ├── server.py             # cardlink-server CLI\n│       │   ├── phone.py              # cardlink-phone CLI\n│       │   ├── modem.py              # cardlink-modem CLI (IoT modems)\n│       │   ├── provision.py          # cardlink-provision CLI\n│       │   └── test.py               # cardlink-test CLI\n│       ├── dashboard/                # Frontend Layer\n│       │   ├── __init__.py\n│       │   ├── server.py             # Dashboard web server\n│       │   ├── websocket.py          # WebSocket handlers\n│       │   ├── routes/               # HTTP route handlers\n│       │   │   ├── __init__.py\n│       │   │   ├── sessions.py       # OTA session management\n│       │   │   ├── commands.py       # Manual RAM commands\n│       │   │   └── logs.py           # Communication logs\n│       │   ├── static/               # Frontend assets\n│       │   │   ├── css/\n│       │   │   ├── js/\n│       │   │   └── index.html\n│       │   └── templates/            # HTML templates (if using Jinja2)\n│       ├── server/                   # Service Layer - Admin Server\n│       │   ├── __init__.py\n│       │   ├── admin_server.py       # PSK-TLS HTTPS server\n│       │   ├── tls_handler.py        # TLS/PSK connection handling\n│       │   ├── tls_monitor.py        # TLS handshake monitoring\n│       │   └── session_manager.py    # Session state management\n│       ├── phone/                    # Service Layer - Phone Controller\n│       │   ├── __init__.py\n│       │   ├── adb_controller.py     # ADB device control\n│       │   ├── at_interface.py       # AT command interface\n│       │   ├── network_manager.py    # WiFi/network control\n│       │   ├── bip_monitor.py        # BIP event monitoring\n│       │   ├── sms_trigger.py        # SMS-PP trigger\n│       │   └── logcat_parser.py      # Android log parsing\n│       ├── modem/                    # Service Layer - IoT Modem Controller\n│       │   ├── __init__.py\n│       │   ├── serial_controller.py  # Serial/USB communication\n│       │   ├── at_interface.py       # AT command interface for modems\n│       │   ├── quectel.py            # Quectel-specific handlers\n│       │   ├── qxdm_interface.py     # QXDM diagnostic integration\n│       │   └── bip_monitor.py        # BIP event monitoring for modems\n│       ├── provision/                # Service Layer - UICC Provisioner\n│       │   ├── __init__.py\n│       │   ├── card_manager.py       # PC/SC card access\n│       │   ├── key_injector.py       # PSK key provisioning\n│       │   ├── url_config.py         # Admin URL setup\n│       │   └── bip_config.py         # BIP settings\n│       ├── network_sim/              # Service Layer - Network Simulator\n│       │   ├── __init__.py\n│       │   ├── amarisoft.py          # Amarisoft integration\n│       │   ├── websocket_client.py   # WebSocket client for simulator\n│       │   └── tcp_client.py         # TCP/IP fallback client\n│       ├── database/                 # Data Layer\n│       │   ├── __init__.py\n│       │   ├── engine.py             # Database engine setup (SQLite/MySQL/PostgreSQL)\n│       │   ├── models.py             # SQLAlchemy ORM models\n│       │   ├── migrations/           # Alembic migrations\n│       │   │   └── versions/\n│       │   ├── repositories/         # Data access layer\n│       │   │   ├── __init__.py\n│       │   │   ├── session_repo.py   # Session data repository\n│       │   │   ├── device_repo.py    # Device configuration repository\n│       │   │   ├── card_repo.py      # UICC card profiles repository\n│       │   │   ├── log_repo.py       # Communication logs repository\n│       │   │   └── test_repo.py      # Test results repository\n│       │   └── schemas.py            # Pydantic schemas for validation\n│       ├── protocol/                 # Protocol Layer\n│       │   ├── __init__.py\n│       │   ├── apdu.py               # C-APDU, R-APDU classes\n│       │   ├── tlv.py                # BER-TLV encoding/decoding\n│       │   ├── gp_commands.py        # GP card command builders\n│       │   ├── http_protocol.py      # HTTP Admin protocol\n│       │   ├── sms_pdu.py            # SMS-PP PDU encoding\n│       │   └── bip_commands.py       # BIP proactive commands\n│       ├── testing/                  # Test Framework\n│       │   ├── __init__.py\n│       │   ├── runner.py             # Test case runner\n│       │   ├── assertions.py         # Test assertions\n│       │   ├── phone_fixtures.py     # Phone test fixtures\n│       │   ├── modem_fixtures.py     # IoT modem test fixtures\n│       │   └── e2e_orchestrator.py   # End-to-end coordinator\n│       └── utils/                    # Shared Utilities\n│           ├── __init__.py\n│           ├── logging.py            # Logging configuration\n│           ├── network.py            # Network utilities\n│           ├── adb_utils.py          # ADB helpers\n│           └── serial_utils.py       # Serial port helpers\n├── tests/\n│   ├── unit/                         # Unit tests\n│   │   ├── test_apdu.py\n│   │   ├── test_tlv.py\n│   │   ├── test_gp_commands.py\n│   │   ├── test_database.py\n│   │   └── ...\n│   ├── integration/                  # Integration tests\n│   │   ├── test_server.py\n│   │   ├── test_phone.py\n│   │   ├── test_modem.py\n│   │   ├── test_repositories.py\n│   │   └── ...\n│   └── e2e/                          # End-to-end tests\n│       ├── test_basic_connectivity.py\n│       └── test_compliance.py\n├── examples/\n│   ├── test_suites/                  # Example test configurations\n│   │   ├── smoke.yaml\n│   │   ├── compliance.yaml\n│   │   └── e2e_basic.yaml\n│   └── configs/                      # Example configurations\n│       ├── uicc_template.yaml\n│       ├── phone_setup.yaml\n│       └── modem_setup.yaml\n├── data/                             # Default data directory\n│   └── cardlink.db                   # SQLite database (default)\n├── docs/\n│   ├── setup_guide.md                # Hardware setup guide\n│   ├── uicc_provisioning.md          # Card provisioning guide\n│   ├── modem_guide.md                # IoT modem guide\n│   ├── dashboard_guide.md            # Dashboard usage guide\n│   ├── database_guide.md             # Database configuration guide\n│   └── troubleshooting.md            # Common issues\n├── pyproject.toml                    # Project configuration\n├── README.md                         # Project overview\n├── CHANGELOG.md                      # Version history\n└── CLAUDE.md                         # AI assistant context\n```\n\n## Naming Conventions\n\n### Files\n- **Modules**: `snake_case.py` (e.g., `admin_server.py`, `adb_controller.py`)\n- **Test files**: `test_<module>.py` (e.g., `test_apdu.py`, `test_server.py`)\n- **Configuration**: `snake_case.yaml` (e.g., `uicc_template.yaml`)\n\n### Code\n- **Classes**: `PascalCase` (e.g., `AdminServer`, `ADBController`, `APDUCommand`)\n- **Functions/Methods**: `snake_case` (e.g., `send_command`, `get_device_info`)\n- **Constants**: `UPPER_SNAKE_CASE` (e.g., `DEFAULT_PORT`, `MAX_TIMEOUT`)\n- **Variables**: `snake_case` (e.g., `session_id`, `psk_key`)\n- **Private members**: `_leading_underscore` (e.g., `_connection`, `_parse_response`)\n\n## Import Patterns\n\n### Import Order\n1. Standard library imports\n2. Third-party library imports\n3. Local application imports (absolute)\n4. Relative imports within same package\n\n### Example\n```python\n# Standard library\nimport logging\nimport threading\nfrom dataclasses import dataclass\nfrom typing import Optional, List\n\n# Third-party\nimport click\nfrom sslpsk3 import SSLContext\nfrom sqlalchemy.orm import Session\n\n# Local absolute imports\nfrom cardlink.protocol.apdu import APDUCommand, APDUResponse\nfrom cardlink.database.repositories import SessionRepository\nfrom cardlink.utils.logging import get_logger\n\n# Relative imports (within same module)\nfrom .session_manager import SessionManager\n```\n\n### Module/Package Organization\n- Use absolute imports from `cardlink` package root\n- Use relative imports within the same sub-package\n- Each sub-package has `__init__.py` exposing public API\n\n## Code Structure Patterns\n\n### Module Organization\n```python\n\"\"\"Module docstring describing purpose.\"\"\"\n\n# 1. Imports (as described above)\n\n# 2. Constants and configuration\nDEFAULT_TIMEOUT = 30\nMAX_RETRIES = 3\n\n# 3. Type definitions / Enums\nclass DeviceState(Enum):\n    CONNECTED = \"connected\"\n    DISCONNECTED = \"disconnected\"\n\n# 4. Data classes\n@dataclass\nclass DeviceInfo:\n    serial: str\n    model: str\n\n# 5. Main classes / functions\nclass Controller:\n    \"\"\"Main implementation.\"\"\"\n    pass\n\n# 6. Helper functions (private)\ndef _parse_response(data: bytes) -> dict:\n    \"\"\"Internal helper.\"\"\"\n    pass\n```\n\n### Class Organization\n```python\nclass AdminServer:\n    \"\"\"Class docstring.\"\"\"\n\n    # Class constants\n    DEFAULT_PORT = 8443\n\n    def __init__(self, ...):\n        \"\"\"Constructor with parameter docs.\"\"\"\n        pass\n\n    # Public methods (alphabetically or by workflow)\n    def start(self):\n        pass\n\n    def stop(self):\n        pass\n\n    # Private methods\n    def _handle_connection(self):\n        pass\n```\n\n### Function Organization\n```python\ndef process_apdu(command: APDUCommand, timeout: int = 30) -> APDUResponse:\n    \"\"\"\n    Process an APDU command.\n\n    Args:\n        command: The APDU command to send\n        timeout: Response timeout in seconds\n\n    Returns:\n        APDUResponse with status and data\n\n    Raises:\n        TimeoutError: If no response within timeout\n        ProtocolError: If invalid response received\n    \"\"\"\n    # 1. Input validation\n    if not command:\n        raise ValueError(\"Command cannot be None\")\n\n    # 2. Core logic\n    response = _send_and_receive(command, timeout)\n\n    # 3. Return result\n    return response\n```\n\n## Code Organization Principles\n\n1. **Single Responsibility**: Each module handles one concern (e.g., `tls_handler.py` only handles TLS, not HTTP parsing)\n2. **Modularity**: Components can be used independently (e.g., phone controller without server)\n3. **Testability**: Classes accept dependencies via constructor for easy mocking\n4. **Consistency**: Follow patterns established in existing code\n\n## Module Boundaries\n\n### Layer Dependencies\n```\nCLI Layer → Service Layer → Protocol Layer\n              ↓      ↓\n         Dashboard   Data Layer (Database)\n           Layer\n```\n\n- **Protocol Layer**: No dependencies on other layers. Pure data structures and encoding.\n- **Data Layer**: No dependencies on other layers. Provides database access via repositories.\n- **Service Layer**: Depends on Protocol Layer and Data Layer. Contains business logic.\n- **CLI Layer**: Depends on Service Layer. Thin wrapper for command-line interface.\n- **Dashboard Layer**: Depends on Service Layer. Provides web UI, can be disabled.\n\n### Cross-Module Communication\n- **Server ↔ Dashboard**: WebSocket for real-time updates, shared session state\n- **Server ↔ Phone/Modem**: Through testing orchestrator, not direct coupling\n- **Network Sim → Server**: Event callbacks, webhook-style integration\n\n### Public API Exposure\nEach package `__init__.py` exports only public classes/functions:\n\n```python\n# cardlink/server/__init__.py\nfrom .admin_server import AdminServer\nfrom .session_manager import Session, SessionManager\n\n__all__ = ['AdminServer', 'Session', 'SessionManager']\n```\n\n## Code Size Guidelines\n\n- **File size**: Maximum 500 lines (split into multiple modules if larger)\n- **Function size**: Maximum 50 lines (extract helpers if larger)\n- **Class size**: Maximum 300 lines (consider splitting responsibilities)\n- **Nesting depth**: Maximum 4 levels (refactor complex conditionals)\n\n## Dashboard Structure\n\n```\nsrc/cardlink/dashboard/\n├── server.py              # Flask/aiohttp app setup\n├── websocket.py           # WebSocket handlers for real-time updates\n├── routes/\n│   ├── sessions.py        # /api/sessions - OTA session management\n│   ├── commands.py        # /api/commands - Manual RAM commands\n│   ├── logs.py            # /api/logs - Communication logs\n│   └── tls.py             # /api/tls - TLS handshake info\n└── static/\n    ├── index.html         # Single-page dashboard\n    ├── css/\n    │   └── styles.css     # Dashboard styles\n    └── js/\n        ├── app.js         # Main application\n        ├── websocket.js   # WebSocket client\n        ├── sessions.js    # Session management UI\n        ├── commands.js    # Command builder UI\n        └── logs.js        # Log viewer UI\n```\n\n### Separation of Concerns\n- Dashboard is self-contained in its own package\n- Own entry point: `cardlink-server start --dashboard` enables web UI\n- Minimal dependencies on core server (only session/command interfaces)\n- Can be completely disabled without affecting CLI/server functionality\n\n## Database Layer\n\n### Database Structure\n```\nsrc/cardlink/database/\n├── __init__.py\n├── engine.py              # Database engine configuration\n├── models.py              # SQLAlchemy ORM models\n├── migrations/            # Alembic database migrations\n│   ├── env.py\n│   ├── alembic.ini\n│   └── versions/          # Migration scripts\n├── repositories/          # Repository pattern for data access\n│   ├── __init__.py\n│   ├── base_repo.py       # Base repository class\n│   ├── session_repo.py    # OTA session data\n│   ├── device_repo.py     # Phone/modem configurations\n│   ├── card_repo.py       # UICC card profiles\n│   ├── log_repo.py        # Communication logs\n│   └── test_repo.py       # Test results and history\n└── schemas.py             # Pydantic schemas for validation\n```\n\n### Database Support\n- **SQLite3** (default): Local file-based, no setup required\n- **MySQL**: For production deployments with multiple users\n- **PostgreSQL**: For enterprise deployments with advanced features\n\n### Database Configuration\n```python\n# Database connection via environment variable or config\nDATABASE_URL = \"sqlite:///data/cardlink.db\"      # Default SQLite\nDATABASE_URL = \"mysql://user:pass@host/cardlink\" # MySQL\nDATABASE_URL = \"postgresql://user:pass@host/cardlink\" # PostgreSQL\n```\n\n### Data Models\n| Model | Purpose | Key Fields |\n|-------|---------|------------|\n| `Device` | Phone/modem configurations | serial, type, name, connection_params |\n| `Card` | UICC card profiles | iccid, psk_identity, psk_key, admin_url |\n| `Session` | OTA session records | id, device_id, card_id, status, timestamps |\n| `CommandLog` | APDU command/response logs | session_id, direction, apdu_hex, timestamp |\n| `TestResult` | Test execution results | test_id, session_id, status, duration, errors |\n| `ServerConfig` | Server settings | key, value, description |\n\n### Repository Pattern\n```python\nclass SessionRepository:\n    \"\"\"Data access for OTA sessions.\"\"\"\n\n    def __init__(self, db: Session):\n        self.db = db\n\n    def create(self, device_id: int, card_id: int) -> SessionModel:\n        \"\"\"Create a new session record.\"\"\"\n        pass\n\n    def get_by_id(self, session_id: int) -> Optional[SessionModel]:\n        \"\"\"Retrieve session by ID.\"\"\"\n        pass\n\n    def get_active(self) -> List[SessionModel]:\n        \"\"\"Get all active sessions.\"\"\"\n        pass\n\n    def add_command_log(self, session_id: int, apdu: bytes, response: bytes):\n        \"\"\"Log APDU exchange.\"\"\"\n        pass\n```\n\n## Documentation Standards\n\n- All public classes and functions must have docstrings (Google style)\n- Complex algorithms should include inline comments\n- Each package should have a README explaining its purpose\n- Type hints required for all public APIs\n\n### Docstring Example\n```python\ndef send_apdu(self, command: APDUCommand, timeout: int = 30) -> APDUResponse:\n    \"\"\"\n    Send an APDU command to the UICC.\n\n    Args:\n        command: The APDU command to transmit.\n        timeout: Maximum time to wait for response in seconds.\n\n    Returns:\n        APDUResponse containing status word and response data.\n\n    Raises:\n        ConnectionError: If not connected to device.\n        TimeoutError: If response not received within timeout.\n\n    Example:\n        >>> cmd = APDUCommand(cla=0x00, ins=0xA4, p1=0x04, p2=0x00)\n        >>> response = controller.send_apdu(cmd)\n        >>> print(response.sw)\n        '9000'\n    \"\"\"\n```\n",
  "fileStats": {
    "size": 17668,
    "lines": 450,
    "lastModified": "2025-11-25T09:45:57.995Z"
  },
  "comments": []
}